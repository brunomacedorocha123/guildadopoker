<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guilda do Poker - Perfil</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg: #121212;
            --bg-2: #1c1c1c;
            --bg-3: #2c2c2c;
            --gold: #ffcc00;
            --text: #f5f5f5;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }

        .user-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: var(--bg-2);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--gold);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 300px;
            width: 100%;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--bg-3);
            border: 2px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .user-avatar:hover {
            transform: scale(1.05);
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-nickname {
            color: var(--gold);
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,204,0,.3);
            border-radius: 50%;
            border-top-color: var(--gold);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #4caf50;
        }

        .status-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .info-text {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div class="user-area" id="user-area">
        <div class="user-avatar" id="user-avatar">
            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSIjZmZjYzAwIj48cGF0aCBkPSJNMTMwLDUwQzEzMCw2Mi44IDEyMCw3Mi41IDEwMCw3Yi41SDcwQzUwLDcyLjUgNDAsNjIuOCA0MCw1MEM0MCwzNy4yIDUwLDI3LjUgNzAsMjcuNUgxMDBDMTIwLDI3LjUgMTMwLDM3LjIgMTMwLDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAsNTAuNUw0MCwxNTBDNDAsMTYyLjggNTAsMTcyLjUgNzAsMTcyLjVIMTMwQzE1MCwxNzIuNSAxNjAsMTYyLjggMTYwLDE1MEwxNjAsNTAuNSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=" alt="Avatar" id="avatar-img">
        </div>
        <div class="user-nickname" id="user-nickname">
            <span class="loading" id="loading-indicator"></span>
            <span id="nickname-text"></span>
        </div>
        <div class="status-indicator">
            <div class="status-dot"></div>
            <span class="status-text" id="status-text">Conectado</span>
        </div>
    </div>

    <div class="info-text">
        <p>Esta é a janela de perfil que aparecerá no fórum, mostrando seu avatar e apelido.</p>
        <p>O sistema utiliza autenticação do Supabase para identificar usuários logados.</p>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://ffyectkjlwgqzjgwhexy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmeWVjdGtqbHdncXpqZ3doZXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTAxNDAsImV4cCI6MjA3MTg4NjE0MH0.bWxnDQaJ6wILzK09TZ9B9ZdUdqVS7bukabBwZDmyvrE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true, autoRefreshToken: true }
        });

        // Função para carregar avatar pelo ID
        async function loadUserAvatar(avatarId) {
            if (!avatarId) return null;
            try {
                const { data: avatarData, error } = await supabase
                    .from('avatares')
                    .select('url_imagem')
                    .eq('id', avatarId)
                    .single();
                    
                if (error || !avatarData) return null;
                return avatarData.url_imagem;
            } catch (error) {
                console.error('Erro ao carregar avatar:', error);
                return null;
            }
        }

        // Função para carregar perfil do usuário
        async function loadUserProfile(userId) {
            try {
                const { data: perfilData, error } = await supabase
                    .from('perfis')
                    .select('apelido_poker, avatar_id')
                    .eq('usuario_id', userId)
                    .single();
                    
                if (error) {
                    console.error('Erro ao carregar perfil:', error);
                    return null;
                }
                return perfilData;
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                return null;
            }
        }

        // Atualiza a janela do usuário
        async function updateUserUI(user, profile) {
            const userAvatarImg = document.getElementById('avatar-img');
            const userNicknameEl = document.getElementById('nickname-text');
            const loadingIndicator = document.getElementById('loading-indicator');
            const userArea = document.getElementById('user-area');

            if (!userArea) return;

            // esconder loading
            if (loadingIndicator) loadingIndicator.style.display = 'none';

            // definir apelido
            let apelido = profile && profile.apelido_poker ? profile.apelido_poker : user.email.split('@')[0];
            if (userNicknameEl) {
                userNicknameEl.textContent = apelido;
                userNicknameEl.style.display = 'inline';
            }

            // carregar avatar
            if (profile && profile.avatar_id) {
                const avatarUrl = await loadUserAvatar(profile.avatar_id);
                if (avatarUrl && userAvatarImg) {
                    userAvatarImg.onerror = function () {
                        console.error('Erro ao carregar avatar, usando padrão');
                        this.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSIjZmZjYzAwIj48cGF0aCBkPSJNMTMwLDUwQzEzMCw2Mi44IDEyMCw3Mi41IDEwMCw3Yi41SDcwQzUwLDcyLjUgNDAsNjIuOCA0MCw1MEM0MCwzNy4yIDUwLDI3LjUgNzAsMjcuNUgxMDBDMTIwLDI3LjUgMTMwLDM3LjIgMTMwLDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAsNTAuNUw0MCwxNTBDNDAsMTYyLjggNTAsMTcyLjUgNzAsMTcyLjVIMTMwQzE1MCwxNzIuNSAxNjAsMTYyLjggMTYwLDE1MEwxNjAsNTAuNSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=";
                    };
                    userAvatarImg.src = avatarUrl;
                }
            }
        }

        // Verificar sessão e carregar perfil ao iniciar
        document.addEventListener('DOMContentLoaded', async function () {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                console.log('Usuário logado:', session.user.email);
                const profile = await loadUserProfile(session.user.id);
                await updateUserUI(session.user, profile);
                
                // Atualizar status
                document.getElementById('status-text').textContent = "Conectado";
            } else {
                console.log('Usuário não logado');
                document.getElementById('user-nickname').textContent = "Visitante";
                document.getElementById('status-text').textContent = "Não conectado";
                document.querySelector('.status-dot').style.backgroundColor = "#f44336";
            }
        });
    </script>
</body>
</html>