<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processando - Guilda do Poker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #121212;
      --bg-2: #1c1c1c;
      --gold: #ffcc00;
      --text: #f5f5f5;
      --success: #4caf50;
      --error: #f44336;
      --warning: #ff9800;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Arial', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, var(--bg), var(--bg-2));
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background-color: var(--bg-2);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      width: 100%;
      max-width: 500px;
      padding: 40px;
      text-align: center;
      border: 2px solid var(--gold);
      animation: fadeIn 0.5s ease-out;
    }
    
    .logo {
      color: var(--gold);
      font-size: 3rem;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
    }
    
    h1 {
      color: var(--gold);
      margin-bottom: 20px;
      font-size: 2rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    p {
      color: #e6e6e6;
      margin-bottom: 25px;
      line-height: 1.6;
      font-size: 16px;
    }
    
    .status {
      padding: 20px;
      border-radius: 10px;
      margin: 25px 0;
      font-weight: 500;
      animation: slideIn 0.5s ease-out;
    }
    
    .loading {
      background: linear-gradient(135deg, rgba(255, 204, 0, 0.1), rgba(255, 204, 0, 0.2));
      color: var(--gold);
      border: 2px solid var(--gold);
    }
    
    .success {
      background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.2));
      color: var(--success);
      border: 2px solid var(--success);
    }
    
    .error {
      background: linear-gradient(135deg, rgba(244, 67, 54, 0.1), rgba(244, 67, 54, 0.2));
      color: var(--error);
      border: 2px solid var(--error);
    }
    
    .warning {
      background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.2));
      color: var(--warning);
      border: 2px solid var(--warning);
    }
    
    .btn {
      display: inline-block;
      background: linear-gradient(135deg, var(--gold), #e6b800);
      color: var(--bg);
      padding: 15px 30px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      margin: 10px;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-size: 14px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(255, 204, 0, 0.3);
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--gold);
      border: 2px solid var(--gold);
    }
    
    .btn-secondary:hover {
      background: rgba(255, 204, 0, 0.1);
      transform: translateY(-2px);
    }
    
    .countdown {
      margin-top: 25px;
      color: #bbb;
      font-size: 14px;
      animation: fadeIn 1s ease-out;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 204, 0, 0.3);
      border-top: 4px solid var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    .checkmark {
      width: 50px;
      height: 50px;
      margin: 0 auto 15px;
      color: var(--success);
    }
    
    .cross {
      width: 50px;
      height: 50px;
      margin: 0 auto 15px;
      color: var(--error);
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .hidden {
      display: none;
    }
    
    .debug-info {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 12px;
      text-align: left;
      color: #bbb;
      max-height: 150px;
      overflow-y: auto;
      border-left: 3px solid var(--gold);
    }
    
    .debug-toggle {
      margin-top: 15px;
      color: #888;
      font-size: 12px;
      cursor: pointer;
      text-decoration: underline;
    }
    
    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255, 204, 0, 0.2);
      border-radius: 2px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--gold);
      border-radius: 2px;
      animation: progress 2s ease-in-out infinite;
    }
    
    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 30px 20px;
        margin: 10px;
      }
      
      h1 {
        font-size: 1.6rem;
      }
      
      .btn {
        padding: 12px 25px;
        font-size: 14px;
        margin: 8px;
      }
      
      .logo {
        font-size: 2.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">‚ô†Ô∏è‚ô•Ô∏è‚ô£Ô∏è‚ô¶Ô∏è</div>
    <h1>Processando Autentica√ß√£o</h1>
    
    <div id="status" class="status loading">
      <div class="spinner"></div>
      <p id="status-message">Iniciando verifica√ß√£o de sess√£o...</p>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
    </div>
    
    <div id="buttons" class="hidden">
      <a href="https://guildadopoker.netlify.app/" class="btn">üè† P√°gina Principal</a>
      <a href="https://guildadopoker.netlify.app/login.html" class="btn btn-secondary">üîë Fazer Login</a>
    </div>
    
    <div id="countdown" class="countdown hidden">
      Redirecionando em <span id="countdown-value">5</span> segundos...
    </div>
    
    <div class="debug-toggle" onclick="toggleDebug()">
      üîç Mostrar/Ocultar Informa√ß√µes de Debug
    </div>
    
    <div id="debug" class="debug-info hidden">
      <strong>üîß Informa√ß√µes de Debug:</strong>
      <div id="debug-content"></div>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURA√á√ÉO SUPABASE
    // ========================================
    const SUPABASE_CONFIG = {
      url: 'https://ffyectkjlwgqzjgwhexy.supabase.co',
      // ‚ö†Ô∏è EM PRODU√á√ÉO, USE VARI√ÅVEIS DE AMBIENTE
      key: window.location.hostname === 'localhost' 
        ? 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmeWVjdGtqbHdncXpqZ3doZXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTAxNDAsImV4cCI6MjA3MTg4NjE0MH0.bWxnDQaJ6wILzK09TZ9B9ZdUdqVS7bukabBwZDmyvrE'
        : '', // Deixar vazio em produ√ß√£o e usar vari√°veis de ambiente
      options: {
        auth: {
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true,
          storage: localStorage,
          flowType: 'pkce'
        }
      }
    };

    // Inicializar Supabase
    const supabase = window.supabase.createClient(
      SUPABASE_CONFIG.url, 
      SUPABASE_CONFIG.key, 
      SUPABASE_CONFIG.options
    );

    // ========================================
    // ELEMENTOS DOM
    // ========================================
    const statusElement = document.getElementById('status');
    const statusMessage = document.getElementById('status-message');
    const buttonsElement = document.getElementById('buttons');
    const countdownElement = document.getElementById('countdown');
    const debugElement = document.getElementById('debug');
    const debugContent = document.getElementById('debug-content');

    // ========================================
    // CONFIGURA√á√ÉO
    // ========================================
    const DEBUG_MODE = true;
    const MAX_RETRY_ATTEMPTS = 3;
    const RETRY_DELAY = 1000;
    const SESSION_CHECK_TIMEOUT = 10000; // 10 segundos

    // ========================================
    // ESTADOS DA APLICA√á√ÉO
    // ========================================
    const STATUS = {
      PROCESSING: 'processing',
      VALIDATING: 'validating',
      SUCCESS: 'success',
      ERROR: 'error',
      WARNING: 'warning'
    };

    const STATUS_MESSAGES = {
      [STATUS.PROCESSING]: "Processando autentica√ß√£o...",
      [STATUS.VALIDATING]: "Validando sess√£o de usu√°rio...",
      [STATUS.SUCCESS]: "Autentica√ß√£o bem-sucedida!",
      [STATUS.ERROR]: "Erro na autentica√ß√£o",
      [STATUS.WARNING]: "Aviso: Sess√£o expirada"
    };

    // ========================================
    // FUN√á√ïES UTILIT√ÅRIAS
    // ========================================
    function logDebug(message) {
      if (DEBUG_MODE) {
        console.log('[DEBUG]', message);
        const timestamp = new Date().toLocaleTimeString();
        debugContent.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        debugElement.scrollTop = debugElement.scrollHeight;
      }
    }

    function toggleDebug() {
      debugElement.classList.toggle('hidden');
    }

    function updateStatus(message, type = STATUS.PROCESSING) {
      statusMessage.textContent = message;
      statusElement.className = `status ${type}`;
      
      // Atualizar conte√∫do baseado no tipo
      switch(type) {
        case STATUS.SUCCESS:
          statusElement.innerHTML = `
            <div class="checkmark">‚úÖ</div>
            <p>${message}</p>
          `;
          break;
        case STATUS.ERROR:
          statusElement.innerHTML = `
            <div class="cross">‚ùå</div>
            <p>${message}</p>
          `;
          break;
        case STATUS.PROCESSING:
          statusElement.innerHTML = `
            <div class="spinner"></div>
            <p>${message}</p>
            <div class="progress-bar">
              <div class="progress-fill"></div>
            </div>
          `;
          break;
        default:
          statusElement.innerHTML = `<p>${message}</p>`;
      }
    }

    function showButtons() {
      buttonsElement.classList.remove('hidden');
    }

    function hideButtons() {
      buttonsElement.classList.add('hidden');
    }

    function startCountdown(url, seconds = 5) {
      let countdown = seconds;
      const countdownValue = document.getElementById('countdown-value');
      countdownValue.textContent = countdown;
      countdownElement.classList.remove('hidden');

      const interval = setInterval(() => {
        countdown--;
        countdownValue.textContent = countdown;
        
        if (countdown <= 0) {
          clearInterval(interval);
          window.location.href = url;
        }
      }, 1000);
    }

    // ========================================
    // FUN√á√ïES DE AUTENTICA√á√ÉO
    // ========================================
    async function processAuthentication() {
      let retryCount = 0;
      
      while (retryCount < MAX_RETRY_ATTEMPTS) {
        try {
          logDebug(`Tentativa ${retryCount + 1} de ${MAX_RETRY_ATTEMPTS}`);
          
          // 1. Verificar par√¢metros da URL primeiro
          const urlParams = new URLSearchParams(window.location.search);
          const statusParam = urlParams.get('status');
          const messageParam = urlParams.get('message');
          
          if (statusParam && messageParam) {
            const decodedMessage = decodeURIComponent(messageParam);
            if (statusParam === 'success') {
              updateStatus(decodedMessage, STATUS.SUCCESS);
              showButtons();
              startCountdown('https://guildadopoker.netlify.app/', 3);
              return true;
            } else if (statusParam === 'error') {
              updateStatus(decodedMessage, STATUS.ERROR);
              showButtons();
              return false;
            }
          }

          // 2. Processar hash de autentica√ß√£o
          updateStatus("Processando URL de autentica√ß√£o...", STATUS.PROCESSING);
          
          if (window.location.hash) {
            logDebug('Hash OAuth detectado na URL');
            const { data, error } = await supabase.auth.getSessionFromUrl();
            
            if (error) {
              logDebug('Erro ao processar hash: ' + error.message);
              throw error;
            }
            
            if (data?.session) {
              logDebug('Sess√£o OAuth processada com sucesso');
              await handleSuccessfulAuth(data.session);
              return true;
            }
          }

          // 3. Verificar sess√£o existente
          updateStatus("Verificando sess√£o atual...", STATUS.VALIDATING);
          const { data: { session }, error: sessionError } = await supabase.auth.getSession();
          
          if (sessionError) {
            logDebug('Erro ao verificar sess√£o: ' + sessionError.message);
            throw sessionError;
          }

          if (session) {
            const isValid = await validateSession(session);
            if (isValid) {
              await handleSuccessfulAuth(session);
              return true;
            }
          }

          // 4. Se n√£o h√° sess√£o v√°lida
          throw new Error('Nenhuma sess√£o de autentica√ß√£o v√°lida encontrada');

        } catch (error) {
          retryCount++;
          logDebug(`Erro na tentativa ${retryCount}: ${error.message}`);
          
          if (retryCount >= MAX_RETRY_ATTEMPTS) {
            await handleAuthFailure(error);
            return false;
          }
          
          // Aguardar antes de tentar novamente
          await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * retryCount));
        }
      }
    }

    async function validateSession(session) {
      try {
        // Verificar expira√ß√£o
        const expiresAt = new Date(session.expires_at);
        const now = new Date();
        const isValid = expiresAt > now;
        
        logDebug(`Sess√£o expira em: ${expiresAt.toLocaleString()}`);
        logDebug(`Sess√£o v√°lida: ${isValid}`);
        
        if (!isValid) {
          logDebug('Tentando renovar sess√£o expirada...');
          const { data, error } = await supabase.auth.refreshSession();
          
          if (error) throw error;
          if (data.session) return true;
        }
        
        return isValid;
      } catch (error) {
        logDebug('Erro na valida√ß√£o da sess√£o: ' + error.message);
        return false;
      }
    }

    async function handleSuccessfulAuth(session) {
      logDebug('Autentica√ß√£o bem-sucedida!');
      logDebug(`Usu√°rio: ${session.user.email}`);
      logDebug(`Expira: ${new Date(session.expires_at).toLocaleString()}`);
      
      updateStatus("Autentica√ß√£o conclu√≠da com sucesso!", STATUS.SUCCESS);
      showButtons();
      startCountdown('https://guildadopoker.netlify.app/', 3);
      
      // Opcional: Registrar evento de login bem-sucedido
      await trackAuthEvent('login_success');
    }

    async function handleAuthFailure(error) {
      logDebug('Falha na autentica√ß√£o ap√≥s todas as tentativas');
      
      updateStatus(
        "N√£o foi poss√≠vel completar a autentica√ß√£o. Por favor, tente novamente.",
        STATUS.ERROR
      );
      
      showButtons();
      
      // Limpar sess√£o inv√°lida
      await cleanupInvalidSession();
      
      // Registrar evento de falha
      await trackAuthEvent('login_failure', error.message);
    }

    async function cleanupInvalidSession() {
      try {
        await supabase.auth.signOut();
        // Limpar storage espec√≠fico do Supabase
        const storageKeys = Object.keys(localStorage).filter(key => 
          key.includes('supabase') || key.includes('sb-')
        );
        
        storageKeys.forEach(key => localStorage.removeItem(key));
        logDebug('Sess√£o inv√°lida limpa com sucesso');
      } catch (error) {
        logDebug('Erro ao limpar sess√£o: ' + error.message);
      }
    }

    async function trackAuthEvent(eventName, details = '') {
      if (!DEBUG_MODE) return;
      
      try {
        logDebug(`Evento de auth: ${eventName} ${details ? '- ' + details : ''}`);
        // Aqui voc√™ pode adicionar tracking para analytics
      } catch (error) {
        logDebug('Erro no tracking: ' + error.message);
      }
    }

    // ========================================
    // LISTENERS DE EVENTOS
    // ========================================
    supabase.auth.onAuthStateChange((event, session) => {
      logDebug(`Estado de auth alterado: ${event}`);
      
      switch(event) {
        case 'SIGNED_IN':
          logDebug('Usu√°rio autenticado com sucesso');
          break;
        case 'SIGNED_OUT':
          logDebug('Usu√°rio desconectado');
          break;
        case 'TOKEN_REFRESHED':
          logDebug('Token renovado');
          break;
        case 'USER_UPDATED':
          logDebug('Usu√°rio atualizado');
          break;
      }
    });

    // ========================================
    // INICIALIZA√á√ÉO
    // ========================================
    document.addEventListener('DOMContentLoaded', async function() {
      logDebug('=== INICIANDO PROCESSAMENTO DE AUTENTICA√á√ÉO ===');
      logDebug(`URL: ${window.location.href}`);
      logDebug(`User Agent: ${navigator.userAgent}`);
      
      try {
        // Adicionar timeout para evitar loops infinitos
        const authTimeout = setTimeout(() => {
          logDebug('Timeout excedido no processamento de auth');
          updateStatus("Tempo excedido. Recarregue a p√°gina e tente novamente.", STATUS.ERROR);
          showButtons();
        }, SESSION_CHECK_TIMEOUT);

        await processAuthentication();
        clearTimeout(authTimeout);
        
      } catch (error) {
        logDebug('Erro fatal na inicializa√ß√£o: ' + error.message);
        updateStatus("Erro inesperado. Recarregue a p√°gina.", STATUS.ERROR);
        showButtons();
      }
    });

    // Handler para errors n√£o capturados
    window.addEventListener('error', (event) => {
      logDebug(`Erro n√£o capturado: ${event.error?.message || 'Unknown error'}`);
    });

    window.addEventListener('unhandledrejection', (event) => {
      logDebug(`Promise rejeitada: ${event.reason?.message || 'Unknown reason'}`);
    });
  </script>
</body>
</html>