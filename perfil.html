<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <title>Meu Perfil - Guilda do Poker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ... (todo o CSS permanece igual) ... */
  </style>
</head>
<body>
  <!-- ... (todo o HTML permanece igual) ... -->

  <!-- Script de autenticação Supabase -->
  <script>
    const supabaseUrl = 'https://ffyectkjlwgqzjgwhexy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhbmFzZSIsInJlZiI6ImZmeWVjdGtqbHdncXpqZ3doZXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTAxNDAsImV4cCI6MjA3MTg4NjE0MH0.bWxnDQaJ6wILzK09TZ9B9ZdUdqVS7bukabBwZDmyvrE';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Elementos DOM (permanecem iguais)
    const userNameElement = document.getElementById('user-name');
    const userEmailElement = document.getElementById('user-email');
    const memberSinceElement = document.getElementById('member-since');
    const nomeCompletoInput = document.getElementById('nome_completo');
    const emailInput = document.getElementById('email');
    const telefoneInput = document.getElementById('telefone');
    const apelidoPokerInput = document.getElementById('apelido_poker');
    const plataformaSelect = document.getElementById('plataforma_preferida');
    const uploadFoto = document.getElementById('upload-foto');
    const uploadText = document.getElementById('upload-text');
    
    const btnEditar = document.getElementById('btn-editar');
    const btnSalvar = document.getElementById('btn-salvar');
    const btnCancelar = document.getElementById('btn-cancelar');
    
    const btnExcluirConta = document.getElementById('btn-excluir-conta');
    const modalExcluir = document.getElementById('modal-excluir');
    const btnCancelarExclusao = document.getElementById('btn-cancelar-exclusao');
    const btnConfirmarExclusao = document.getElementById('btn-confirmar-exclusao');
    const logoutBtn = document.getElementById('logout-btn');

    // Estado de edição
    let editMode = false;
    let originalValues = {};

    async function checkAuthState() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const authButtons = document.getElementById('auth-buttons');
        
        if (!authButtons) return;
        
        if (session) {
          authButtons.innerHTML = `
            <button id="logout-btn" class="auth-btn logout-btn">Sair</button>
          `;
          
          // Reatribuir o event listener ao botão de logout
          document.getElementById('logout-btn').addEventListener('click', logout);
          
          // Carregar dados do usuário
          await loadUserData(session.user);
        } else {
          // Se não estiver logado, redirecionar para a página inicial (index.html)
          console.log('Usuário não autenticado, redirecionando para index.html');
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('Erro ao verificar estado de autenticação:', error);
        alert('Erro de conexão. Tente novamente.');
      }
    }

    async function loadUserData(user) {
      try {
        // Carregar dados do perfil do usuário da tabela 'perfis'
        const { data, error } = await supabase
          .from('perfis')
          .select('*')
          .eq('id', user.id)
          .single();
        
        if (error && error.code === 'PGRST116') {
          // Se não encontrar perfil, criar um básico
          console.log('Perfil não encontrado, criando novo...');
          await createUserProfile(user);
          // Recarregar dados após criar
          await loadUserData(user);
          return;
        } else if (error) {
          console.error('Erro ao carregar perfil:', error);
          alert('Erro ao carregar dados do perfil. Tente recarregar a página.');
          return;
        }
        
        // Preencher dados do usuário
        userNameElement.textContent = data.nome_completo || user.user_metadata.full_name || 'Usuário';
        userEmailElement.textContent = user.email;
        
        // Formatar data de criação
        const createdDate = new Date(user.created_at);
        memberSinceElement.textContent = createdDate.toLocaleDateString('pt-BR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        // Preencher formulário
        nomeCompletoInput.value = data.nome_completo || user.user_metadata.full_name || '';
        emailInput.value = user.email;
        telefoneInput.value = data.telefone || '';
        apelidoPokerInput.value = data.apelido_poker || '';
        plataformaSelect.value = data.plataforma_preferida || '';
        
        // Carregar foto de perfil se existir
        if (data.url_avatar) {
          const img = uploadFoto.querySelector('img');
          img.src = data.url_avatar;
        }
        
        // Salvar valores originais
        originalValues = {
          nome_completo: nomeCompletoInput.value,
          email: emailInput.value,
          telefone: telefoneInput.value,
          apelido_poker: apelidoPokerInput.value,
          plataforma_preferida: plataformaSelect.value
        };
        
      } catch (error) {
        console.error('Erro ao carregar dados do usuário:', error);
        alert('Erro ao carregar dados. Tente recarregar a página.');
      }
    }
    
    async function createUserProfile(user) {
      try {
        const { error } = await supabase
          .from('perfis')
          .insert([
            { 
              id: user.id, 
              nome_completo: user.user_metadata.full_name || '',
              email: user.email,
              data_criacao: new Date().toISOString()
            }
          ]);
        
        if (error) {
          console.error('Erro ao criar perfil:', error);
          // Não alertar o usuário aqui para não ser intrusivo
        }
      } catch (error) {
        console.error('Erro inesperado ao criar perfil:', error);
      }
    }
    
    async function updateUserProfile() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          alert('Sessão expirada. Faça login novamente.');
          window.location.href = 'index.html';
          return false;
        }
        
        // Validação básica dos campos
        if (!nomeCompletoInput.value.trim()) {
          alert('Por favor, informe seu nome completo.');
          nomeCompletoInput.focus();
          return false;
        }
        
        if (!emailInput.value.trim() || !emailInput.value.includes('@')) {
          alert('Por favor, informe um e-mail válido.');
          emailInput.focus();
          return false;
        }
        
        const updates = {
          nome_completo: nomeCompletoInput.value.trim(),
          email: emailInput.value.trim(),
          telefone: telefoneInput.value.trim(),
          apelido_poker: apelidoPokerInput.value.trim(),
          plataforma_preferida: plataformaSelect.value,
          data_atualizacao: new Date().toISOString()
        };
        
        const { error } = await supabase
          .from('perfis')
          .update(updates)
          .eq('id', session.user.id);
        
        if (error) {
          console.error('Erro ao atualizar perfil:', error);
          
          // Verificar se é erro de estrutura da tabela
          if (error.message.includes('column') && error.message.includes('does not exist')) {
            alert('Erro no servidor. Entre em contato com o suporte.');
          } else {
            alert('Erro ao salvar alterações. Tente novamente.');
          }
          return false;
        } else {
          alert('Perfil atualizado com sucesso!');
          // Atualizar o nome exibido no cabeçalho
          userNameElement.textContent = nomeCompletoInput.value;
          userEmailElement.textContent = emailInput.value;
          return true;
        }
      } catch (error) {
        console.error('Erro inesperado ao atualizar perfil:', error);
        alert('Erro inesperado. Tente novamente.');
        return false;
      }
    }
    
    async function deleteUserAccount() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;
        
        // Primeiro excluir o perfil da tabela 'perfis'
        const { error: profileError } = await supabase
          .from('perfis')
          .delete()
          .eq('id', session.user.id);
        
        if (profileError) {
          console.error('Erro ao excluir perfil:', profileError);
        }
        
        // Depois excluir o usuário do auth
        const { error } = await supabase.auth.admin.deleteUser(session.user.id);
        
        if (error) {
          console.error('Erro ao excluir conta:', error);
          alert('Erro ao excluir conta. Tente novamente.');
        } else {
          alert('Sua conta foi excluída com sucesso.');
          await logout();
        }
      } catch (error) {
        console.error('Erro ao excluir conta:', error);
        alert('Erro ao excluir conta. Tente novamente.');
      }
    }

    async function logout() {
      try {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        window.location.href = 'index.html'; // Redirecionar mesmo com erro
      }
    }

    // Event Listeners (permanecem iguais)
    btnEditar.addEventListener('click', () => {
      editMode = true;
      nomeCompletoInput.disabled = false;
      emailInput.disabled = false;
      telefoneInput.disabled = false;
      apelidoPokerInput.disabled = false;
      plataformaSelect.disabled = false;
      btnEditar.style.display = 'none';
      btnSalvar.style.display = 'inline-block';
      btnCancelar.style.display = 'inline-block';
    });
    
    btnCancelar.addEventListener('click', () => {
      editMode = false;
      nomeCompletoInput.disabled = true;
      emailInput.disabled = true;
      telefoneInput.disabled = true;
      apelidoPokerInput.disabled = true;
      plataformaSelect.disabled = true;
      nomeCompletoInput.value = originalValues.nome_completo;
      emailInput.value = originalValues.email;
      telefoneInput.value = originalValues.telefone;
      apelidoPokerInput.value = originalValues.apelido_poker;
      plataformaSelect.value = originalValues.plataforma_preferida;
      btnEditar.style.display = 'inline-block';
      btnSalvar.style.display = 'none';
      btnCancelar.style.display = 'none';
    });
    
    btnSalvar.addEventListener('click', async () => {
      const success = await updateUserProfile();
      if (success) {
        editMode = false;
        nomeCompletoInput.disabled = true;
        emailInput.disabled = true;
        telefoneInput.disabled = true;
        apelidoPokerInput.disabled = true;
        plataformaSelect.disabled = true;
        
        // Atualizar valores originais
        originalValues = {
          nome_completo: nomeCompletoInput.value,
          email: emailInput.value,
          telefone: telefoneInput.value,
          apelido_poker: apelidoPokerInput.value,
          plataforma_preferida: plataformaSelect.value
        };
        
        btnEditar.style.display = 'inline-block';
        btnSalvar.style.display = 'none';
        btnCancelar.style.display = 'none';
      }
    });
    
    uploadFoto.addEventListener('click', () => {
      alert('Funcionalidade de upload de imagem será implementada em breve!');
    });
    
    uploadText.addEventListener('click', () => {
      alert('Funcionalidade de upload de imagem será implementada em breve!');
    });
    
    btnExcluirConta.addEventListener('click', () => {
      modalExcluir.style.display = 'flex';
    });
    
    btnCancelarExclusao.addEventListener('click', () => {
      modalExcluir.style.display = 'none';
    });
    
    btnConfirmarExclusao.addEventListener('click', async () => {
      modalExcluir.style.display = 'none';
      await deleteUserAccount();
    });
    
    // Adicionar event listener para o botão de logout
    if (logoutBtn) {
      logoutBtn.addEventListener('click', logout);
    }
    
    // Fechar modal clicando fora
    window.addEventListener('click', (event) => {
      if (event.target === modalExcluir) {
        modalExcluir.style.display = 'none';
      }
    });

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthState();
    });

    supabase.auth.onAuthStateChange((event, session) => {
      checkAuthState();
    });
  </script>

</body>
</html>