<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <title>Meu Perfil - Guilda do Poker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background-color: #0d2818;
      color: #f4f4f4;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: #133a1b;
      padding: 15px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #c8b653;
      text-decoration: none;
      display: flex;
      align-items: center;
    }
    
    .logo i {
      margin-right: 10px;
    }
    
    .auth-buttons {
      display: flex;
      gap: 10px;
    }
    
    .auth-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .login-btn {
      background-color: transparent;
      color: #c8b653;
      border: 1px solid #c8b653;
    }
    
    .login-btn:hover {
      background-color: #c8b653;
      color: #0d2818;
    }
    
    .logout-btn {
      background-color: #c8b653;
      color: #0d2818;
    }
    
    .logout-btn:hover {
      background-color: #b3a347;
    }
    
    .profile-header {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 30px 0;
      text-align: center;
    }
    
    .profile-picture {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: #1c4c29;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      overflow: hidden;
      border: 3px solid #c8b653;
    }
    
    .profile-picture img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-picture i {
      font-size: 40px;
      color: #c8b653;
    }
    
    .profile-info h1 {
      font-size: 28px;
      margin-bottom: 5px;
      color: #c8b653;
    }
    
    .profile-info p {
      color: #a7c4a9;
      margin-bottom: 5px;
    }
    
    .profile-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
    }
    
    @media (min-width: 768px) {
      .profile-content {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .info-section {
      background-color: #1c4c29;
      border-radius: 10px;
      padding: 25px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .info-section h2 {
      color: #c8b653;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #2d6b3e;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #c8b653;
      font-weight: 600;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #2d6b3e;
      border-radius: 5px;
      background-color: #133a1b;
      color: #f4f4f4;
      font-size: 16px;
    }
    
    .form-group input:disabled,
    .form-group select:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background-color: #c8b653;
      color: #0d2818;
    }
    
    .btn-primary:hover {
      background-color: #b3a347;
    }
    
    .btn-secondary {
      background-color: #2d6b3e;
      color: #f4f4f4;
    }
    
    .btn-secondary:hover {
      background-color: #3a7c4e;
    }
    
    .btn-danger {
      background-color: #8b0000;
      color: #f4f4f4;
    }
    
    .btn-danger:hover {
      background-color: #a52a2a;
    }
    
    .btn-hidden {
      display: none;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: #1c4c29;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .modal h3 {
      color: #c8b653;
      margin-bottom: 15px;
    }
    
    .modal p {
      margin-bottom: 25px;
      color: #f4f4f4;
    }
    
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }
    
    .chip-count {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
      background-color: #133a1b;
      padding: 10px 15px;
      border-radius: 20px;
      width: fit-content;
      margin: 10px auto 0;
    }
    
    .chip-count i {
      color: #c8b653;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="#" class="logo">
        <i>‚ô†</i> Guilda do Poker
      </a>
      <div id="auth-buttons" class="auth-buttons">
        <!-- Bot√µes de autentica√ß√£o ser√£o inseridos aqui via JavaScript -->
      </div>
    </div>
  </header>

  <div class="container">
    <div class="profile-header">
      <div class="profile-picture" id="upload-foto">
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMxYzRjMjkiLz48dGV4dCB4PSI2MCIgeT0iNjUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0MCIgZmlsbD0iI2M4YjY1MyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+8J+SujwvdGV4dD48L3N2Zz4=" alt="Foto de perfil">
        <span id="upload-text" style="display:none;">Alterar Foto</span>
      </div>
      <div class="profile-info">
        <h1 id="user-name">Usu√°rio</h1>
        <p id="user-email">usuario@exemplo.com</p>
        <p>Membro desde: <span id="member-since">01/01/2023</span></p>
        <div class="chip-count">
          <i>ü™ô</i> <span id="chip-count">10.000</span> fichas
        </div>
      </div>
    </div>
    
    <div class="profile-content">
      <div class="info-section">
        <h2>Informa√ß√µes Pessoais</h2>
        <form id="profile-form">
          <div class="form-group">
            <label for="nome_completo">Nome Completo</label>
            <input type="text" id="nome_completo" name="nome_completo" disabled>
          </div>
          
          <div class="form-group">
            <label for="telefone">Telefone</label>
            <input type="tel" id="telefone" name="telefone" disabled>
          </div>
          
          <div class="form-group">
            <label for="apelido_poker">Apelido no Poker</label>
            <input type="text" id="apelido_poker" name="apelido_poker" disabled>
          </div>
          
          <div class="form-group">
            <label for="plataforma_preferida">Plataforma Preferida</label>
            <select id="plataforma_preferida" name="plataforma_preferida" disabled>
              <option value="">Selecione uma plataforma</option>
              <option value="pokerstars">PokerStars</option>
              <option value="ggpoker">GGPoker</option>
              <option value="partypoker">PartyPoker</option>
              <option value="888poker">888poker</option>
              <option value="outras">Outras</option>
            </select>
          </div>
          
          <div class="action-buttons">
            <button type="button" id="btn-editar" class="btn btn-primary">Editar Perfil</button>
            <button type="button" id="btn-salvar" class="btn btn-primary btn-hidden">Salvar</button>
            <button type="button" id="btn-cancelar" class="btn btn-secondary btn-hidden">Cancelar</button>
          </div>
        </form>
      </div>
      
      <div class="info-section">
        <h2>Estat√≠sticas</h2>
        <p>Em breve: estat√≠sticas de jogo, hist√≥rico de torneios e desempenho.</p>
        <div class="action-buttons">
          <button type="button" id="btn-excluir-conta" class="btn btn-danger">Excluir Conta</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o para exclus√£o de conta -->
  <div id="modal-excluir" class="modal">
    <div class="modal-content">
      <h3>Confirmar Exclus√£o</h3>
      <p>Tem certeza que deseja excluir sua conta? Esta a√ß√£o n√£o pode ser desfeita e todos os seus dados ser√£o perdidos.</p>
      <div class="modal-buttons">
        <button id="btn-cancelar-exclusao" class="btn btn-secondary">Cancelar</button>
        <button id="btn-confirmar-exclusao" class="btn btn-danger">Excluir Conta</button>
      </div>
    </div>
  </div>

  <script>
    // Configura√ß√£o do Supabase
    const supabaseUrl = 'https://ffyectkjlwgqzjgwhexy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmeWVjdGtqbHdncXpqZ3doZXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTAxNDAsImV4cCI6MjA3MTg4NjE0MH0.bWxnDQaJ6wILzK09TZ9B9ZdUdqVS7bukabBwZDmyvrE';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Elementos DOM
    const userNameElement = document.getElementById('user-name');
    const userEmailElement = document.getElementById('user-email');
    const memberSinceElement = document.getElementById('member-since');
    const nomeCompletoInput = document.getElementById('nome_completo');
    const telefoneInput = document.getElementById('telefone');
    const apelidoPokerInput = document.getElementById('apelido_poker');
    const plataformaSelect = document.getElementById('plataforma_preferida');
    const uploadFoto = document.getElementById('upload-foto');
    const uploadText = document.getElementById('upload-text');
    
    const btnEditar = document.getElementById('btn-editar');
    const btnSalvar = document.getElementById('btn-salvar');
    const btnCancelar = document.getElementById('btn-cancelar');
    
    const btnExcluirConta = document.getElementById('btn-excluir-conta');
    const modalExcluir = document.getElementById('modal-excluir');
    const btnCancelarExclusao = document.getElementById('btn-cancelar-exclusao');
    const btnConfirmarExclusao = document.getElementById('btn-confirmar-exclusao');

    // Estado de edi√ß√£o
    let editMode = false;
    let originalValues = {};

    // Verificar estado de autentica√ß√£o
    async function checkAuthState() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        const authButtons = document.getElementById('auth-buttons');
        
        if (!authButtons) return;
        
        if (session) {
          authButtons.innerHTML = `
            <button id="logout-btn" class="auth-btn logout-btn">Sair</button>
          `;
          
          // Reatribuir o event listener ao bot√£o de logout
          document.getElementById('logout-btn').addEventListener('click', logout);
          
          // Carregar dados do usu√°rio
          await loadUserData(session.user);
        } else {
          // Se n√£o estiver logado, redirecionar para a p√°gina inicial
          console.log('Usu√°rio n√£o autenticado, redirecionando para index.html');
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('Erro ao verificar estado de autentica√ß√£o:', error);
        alert('Erro de conex√£o. Tente novamente.');
      }
    }

    // Carregar dados do usu√°rio
    async function loadUserData(user) {
      try {
        // Carregar dados do perfil do usu√°rio da tabela 'perfis'
        const { data, error } = await supabase
          .from('perfis')
          .select('*')
          .eq('id', user.id)
          .single();
        
        if (error && error.code === 'PGRST116') {
          // Se n√£o encontrar perfil, criar um b√°sico
          console.log('Perfil n√£o encontrado, criando novo...');
          await createUserProfile(user);
          // Recarregar dados ap√≥s criar
          await loadUserData(user);
          return;
        } else if (error) {
          console.error('Erro ao carregar perfil:', error);
          alert('Erro ao carregar dados do perfil. Tente recarregar a p√°gina.');
          return;
        }
        
        // Preencher dados do usu√°rio
        userNameElement.textContent = data.nome_completo || user.user_metadata.full_name || 'Usu√°rio';
        userEmailElement.textContent = user.email;
        
        // Formatar data de cria√ß√£o
        const createdDate = new Date(user.created_at);
        memberSinceElement.textContent = createdDate.toLocaleDateString('pt-BR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        
        // Preencher formul√°rio (sem o campo de e-mail)
        nomeCompletoInput.value = data.nome_completo || user.user_metadata.full_name || '';
        telefoneInput.value = data.telefone || '';
        apelidoPokerInput.value = data.apelido_poker || '';
        plataformaSelect.value = data.plataforma_preferida || '';
        
        // Carregar foto de perfil se existir
        if (data.url_avatar) {
          const img = uploadFoto.querySelector('img');
          img.src = data.url_avatar;
        }
        
        // Salvar valores originais (sem o e-mail)
        originalValues = {
          nome_completo: nomeCompletoInput.value,
          telefone: telefoneInput.value,
          apelido_poker: apelidoPokerInput.value,
          plataforma_preferida: plataformaSelect.value
        };
        
      } catch (error) {
        console.error('Erro ao carregar dados do usu√°rio:', error);
        alert('Erro ao carregar dados. Tente recarregar a p√°gina.');
      }
    }
    
    // Criar perfil de usu√°rio
    async function createUserProfile(user) {
      try {
        const { error } = await supabase
          .from('perfis')
          .insert([
            { 
              id: user.id, 
              nome_completo: user.user_metadata.full_name || '',
              email: user.email,
              data_criacao: new Date().toISOString()
            }
          ]);
        
        if (error) {
          console.error('Erro ao criar perfil:', error);
        }
      } catch (error) {
        console.error('Erro inesperado ao criar perfil:', error);
      }
    }
    
    // Atualizar perfil do usu√°rio
    async function updateUserProfile() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          alert('Sess√£o expirada. Fa√ßa login novamente.');
          window.location.href = 'index.html';
          return false;
        }
        
        // Valida√ß√£o b√°sica dos campos (sem valida√ß√£o de e-mail)
        if (!nomeCompletoInput.value.trim()) {
          alert('Por favor, informe seu nome completo.');
          nomeCompletoInput.focus();
          return false;
        }
        
        const updates = {
          nome_completo: nomeCompletoInput.value.trim(),
          telefone: telefoneInput.value.trim(),
          apelido_poker: apelidoPokerInput.value.trim(),
          plataforma_preferida: plataformaSelect.value,
          data_atualizacao: new Date().toISOString()
        };
        
        const { error } = await supabase
          .from('perfis')
          .update(updates)
          .eq('id', session.user.id);
        
        if (error) {
          console.error('Erro ao atualizar perfil:', error);
          alert('Erro ao salvar altera√ß√µes. Tente novamente.');
          return false;
        } else {
          alert('Perfil atualizado com sucesso!');
          // Atualizar o nome exibido no cabe√ßalho
          userNameElement.textContent = nomeCompletoInput.value;
          return true;
        }
      } catch (error) {
        console.error('Erro inesperado ao atualizar perfil:', error);
        alert('Erro inesperado. Tente novamente.');
        return false;
      }
    }
    
    // Excluir conta do usu√°rio
    async function deleteUserAccount() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;
        
        // Primeiro excluir o perfil da tabela 'perfis'
        const { error: profileError } = await supabase
          .from('perfis')
          .delete()
          .eq('id', session.user.id);
        
        if (profileError) {
          console.error('Erro ao excluir perfil:', profileError);
        }
        
        // Depois excluir o usu√°rio do auth
        const { error } = await supabase.auth.admin.deleteUser(session.user.id);
        
        if (error) {
          console.error('Erro ao excluir conta:', error);
          alert('Erro ao excluir conta. Tente novamente.');
        } else {
          alert('Sua conta foi exclu√≠da com sucesso.');
          await logout();
        }
      } catch (error) {
        console.error('Erro ao excluir conta:', error);
        alert('Erro ao excluir conta. Tente novamente.');
      }
    }

    // Logout
    async function logout() {
      try {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Erro ao fazer logout:', error);
        window.location.href = 'index.html';
      }
    }

    // Event Listeners
    btnEditar.addEventListener('click', () => {
      editMode = true;
      nomeCompletoInput.disabled = false;
      telefoneInput.disabled = false;
      apelidoPokerInput.disabled = false;
      plataformaSelect.disabled = false;
      btnEditar.style.display = 'none';
      btnSalvar.style.display = 'inline-block';
      btnCancelar.style.display = 'inline-block';
    });
    
    btnCancelar.addEventListener('click', () => {
      editMode = false;
      nomeCompletoInput.disabled = true;
      telefoneInput.disabled = true;
      apelidoPokerInput.disabled = true;
      plataformaSelect.disabled = true;
      nomeCompletoInput.value = originalValues.nome_completo;
      telefoneInput.value = originalValues.telefone;
      apelidoPokerInput.value = originalValues.apelido_poker;
      plataformaSelect.value = originalValues.plataforma_preferida;
      btnEditar.style.display = 'inline-block';
      btnSalvar.style.display = 'none';
      btnCancelar.style.display = 'none';
    });
    
    btnSalvar.addEventListener('click', async () => {
      const success = await updateUserProfile();
      if (success) {
        editMode = false;
        nomeCompletoInput.disabled = true;
        telefoneInput.disabled = true;
        apelidoPokerInput.disabled = true;
        plataformaSelect.disabled = true;
        
        // Atualizar valores originais (sem o e-mail)
        originalValues = {
          nome_completo: nomeCompletoInput.value,
          telefone: telefoneInput.value,
          apelido_poker: apelidoPokerInput.value,
          plataforma_preferida: plataformaSelect.value
        };
        
        btnEditar.style.display = 'inline-block';
        btnSalvar.style.display = 'none';
        btnCancelar.style.display = 'none';
      }
    });
    
    uploadFoto.addEventListener('click', () => {
      alert('Funcionalidade de upload de imagem ser√° implementada em breve!');
    });
    
    btnExcluirConta.addEventListener('click', () => {
      modalExcluir.style.display = 'flex';
    });
    
    btnCancelarExclusao.addEventListener('click', () => {
      modalExcluir.style.display = 'none';
    });
    
    btnConfirmarExclusao.addEventListener('click', async () => {
      modalExcluir.style.display = 'none';
      await deleteUserAccount();
    });
    
    // Fechar modal clicando fora
    window.addEventListener('click', (event) => {
      if (event.target === modalExcluir) {
        modalExcluir.style.display = 'none';
      }
    });

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthState();
    });

    // Monitorar mudan√ßas de autentica√ß√£o
    supabase.auth.onAuthStateChange((event, session) => {
      checkAuthState();
    });
  </script>
</body>
</html>