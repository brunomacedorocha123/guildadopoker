<!DOCTYPE html>
<html lang="pt-BR">
<head>
 <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
 <link rel="icon" href="/favicon.ico" type="image/x-icon">
 <title>Meu Perfil - Guilda do Poker</title>
 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
 <style>
:root {
  --bg: #121212;
  --bg-2: #1c1c1c;
  --bg-3: #2c2c2c;
  --gold: #ffcc00;
  --text: #f5f5f5;
  --success: #4caf50;
  --error: #f44336;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: Arial, sans-serif;
  background-color: var(--bg);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

header {
  background: var(--bg-2);
  padding: 20px;
  text-align: center;
  border-bottom: 2px solid var(--gold);
  position: relative;
  min-height: 80px;
}

nav {
  background: var(--bg-3);
  padding: 10px;
  text-align: center;
  position: relative;
}

.nav-container {
  max-width: 1000px;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  position: relative;
}

.menu {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  list-style: none;
}

.menu li {
  margin: 0;
}

nav a {
  color: var(--gold);
  margin: 0 15px;
  text-decoration: none;
  font-weight: bold;
  transition: all 0.3s ease;
  display: block;
  padding: 10px 0;
}

nav a:hover, 
nav a.active { 
  color: #ffffff; 
  text-decoration: underline;
  background-color: rgba(255, 204, 0, 0.15);
  border-radius: 5px;
}

/* Menu Mobile */
.menu-toggle {
  display: none;
  flex-direction: column;
  justify-content: space-around;
  width: 42px;
  height: 36px;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 0;
  position: absolute;
  right: 25px;
  top: 20px;
  z-index: 1001;
}

.menu-toggle span {
  width: 100%;
  height: 4px;
  background-color: var(--gold);
  border-radius: 3px;
  transition: all 0.3s ease;
}

.menu-toggle.active span:nth-child(1) {
  transform: rotate(45deg) translate(8px, 8px);
}

.menu-toggle.active span:nth-child(2) {
  opacity: 0;
}

.menu-toggle.active span:nth-child(3) {
  transform: rotate(-45deg) translate(7px, -7px);
}

main {
  max-width: 1000px;
  margin: 40px auto;
  padding: 0 20px;
  flex: 1;
}

/* Estilos específicos do perfil */
.profile-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 30px;
  text-align: center;
  padding: 20px;
  background: linear-gradient(135deg, var(--bg-2), var(--bg-3));
  border-radius: 15px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
}

.profile-picture {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background-color: var(--bg-2);
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  overflow: hidden;
  border: 3px solid var(--gold);
  cursor: pointer;
  position: relative;
  transition: all 0.3s ease;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
}

.profile-picture:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 25px rgba(255, 204, 0, 0.2);
}

.profile-picture img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.profile-picture:hover img {
  transform: scale(1.1);
}

.profile-picture:hover .upload-overlay {
  opacity: 1;
}

.upload-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  opacity: 0;
  transition: opacity 0.3s ease;
  color: var(--gold);
  font-weight: bold;
  gap: 5px;
}

.upload-overlay::before {
  content: '📷';
  font-size: 20px;
}

.profile-info h1 {
  color: var(--gold);
  margin-bottom: 10px;
  font-size: 24px;
}

.profile-info .poker-nickname {
  color: var(--gold);
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 10px;
  font-style: italic;
}

.profile-info p {
  color: #e6e6e6;
  margin-bottom: 5px;
}

.profile-content {
  display: flex;
  justify-content: center;
}

.info-section {
  background: linear-gradient(135deg, var(--bg-2), var(--bg-3));
  padding: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
  width: 100%;
  max-width: 600px;
  border: 1px solid var(--bg-3);
}

.info-section h2 {
  color: var(--gold);
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 2px solid var(--bg-3);
  text-align: center;
  font-size: 22px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--gold);
  font-weight: bold;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 12px 15px;
  border: 1px solid var(--bg-3);
  border-radius: 8px;
  background-color: var(--bg-3);
  color: var(--text);
  font-size: 16px;
  transition: all 0.3s ease;
}

.form-group input:disabled,
.form-group select:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  background-color: var(--bg-3);
}

.form-group input:not(:disabled),
.form-group select:not(:disabled) {
  opacity: 1;
  cursor: text;
  background-color: var(--bg-2);
  border: 1px solid var(--gold);
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--gold);
  box-shadow: 0 0 15px rgba(255, 204, 0, 0.2);
  background-color: var(--bg-2);
}

.action-buttons {
  display: flex;
  gap: 15px;
  margin-top: 25px;
  flex-wrap: wrap;
}

.btn {
  padding: 12px 25px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s ease;
  flex: 1;
  min-width: 120px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.btn:active {
  transform: translateY(0);
}

.btn-primary {
  background-color: var(--gold);
  color: #121212;
}

.btn-primary:hover {
  background-color: #e6b800;
}

.btn-secondary {
  background-color: var(--bg-3);
  color: var(--text);
}

.btn-secondary:hover {
  background-color: #3a3a3a;
}

.btn-hidden {
  display: none !important;
}

.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 15px 20px;
  border-radius: 10px;
  background-color: var(--bg-2);
  color: var(--text);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 10px;
  transform: translateX(100%);
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
  font-weight: bold;
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  background: linear-gradient(135deg, var(--bg-2), #2d4a2d);
  border-left: 5px solid var(--success);
}

.notification.error {
  background: linear-gradient(135deg, var(--bg-2), #4a2d2d);
  border-left: 5px solid var(--error);
}

.notification-icon {
  font-size: 20px;
}

footer {
  text-align: center;
  padding: 20px;
  background: var(--bg-2);
  margin-top: 40px;
  border-top: 2px solid var(--gold);
  font-size: 14px;
  color: #bbb;
}

footer div {
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
}

footer img { 
  max-height: 40px; 
  height: auto; 
}

.aviso18 {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}

.icone18 {
  background: red;
  color: white;
  font-weight: bold;
  font-size: 14px;
  padding: 4px 8px;
  border-radius: 5px;
}

.aviso18 p { 
  margin: 0; 
  color: #ccc; 
}

/* ===== MODAL DE AVATARES - ESTILOS CORRIGIDOS ===== */
.avatar-modal {
  display: none;
  position: fixed;
  z-index: 10000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
  backdrop-filter: blur(5px);
}

.modal-content {
  background-color: var(--bg-2);
  margin: 2% auto;
  padding: 25px;
  border-radius: 15px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
  border: 2px solid var(--gold);
  animation: modalFadeIn 0.3s ease-out;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 15px;
  border-bottom: 2px solid var(--bg-3);
}

.modal-header h2 {
  color: var(--gold);
  margin: 0;
  font-size: 28px;
  text-align: center;
  flex: 1;
}

.close-modal {
  color: var(--text);
  font-size: 32px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  background: none;
  border: none;
  padding: 0;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-modal:hover {
  color: var(--gold);
  transform: scale(1.1);
}

.modal-body {
  padding: 15px 0;
}

.avatar-options {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 20px;
  justify-content: center;
  align-items: center;
  padding: 10px;
}

.avatar-option {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  overflow: hidden;
  cursor: pointer;
  border: 3px solid var(--bg-3);
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  margin: 0 auto;
  position: relative;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.avatar-option:hover {
  transform: scale(1.1);
  border-color: var(--gold);
  box-shadow: 0 6px 20px rgba(255, 204, 0, 0.4);
}

.avatar-option.selected {
  border: 4px solid var(--gold);
  transform: scale(1.1);
  box-shadow: 0 0 25px rgba(255, 204, 0, 0.6);
}

.avatar-option img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.avatar-option:hover img {
  transform: scale(1.1);
}

.avatar-name {
  position: absolute;
  bottom: -25px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-3);
  color: var(--text);
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 11px;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.avatar-option:hover .avatar-name {
  opacity: 1;
}

.avatar-options > p {
  grid-column: 1 / -1;
  text-align: center;
  color: var(--text);
  padding: 40px 20px;
  font-size: 16px;
}

/* Scrollbar personalizada */
.modal-content::-webkit-scrollbar {
  width: 8px;
}

.modal-content::-webkit-scrollbar-track {
  background: var(--bg-3);
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb {
  background: var(--gold);
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
  background: #e6b800;
}

/* Animações */
@keyframes modalFadeIn {
  from {
    opacity: 0;
    transform: translateY(-50px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Loading state */
.avatar-loading {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 200px;
  color: var(--text);
  font-style: italic;
  grid-column: 1 / -1;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--bg-3);
  border-top: 4px solid var(--gold);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 15px;
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 768px) {
  header {
    justify-content: center;
    padding: 15px;
    position: relative;
  }

  nav {
    padding: 0;
    background: transparent;
  }

  .menu-toggle {
    display: flex;
    width: 40px;
    height: 34px;
    right: 20px;
    top: 20px;
  }

  .menu {
    display: none;
    flex-direction: column;
    width: 100%;
    position: absolute;
    top: 100%;
    left: 0;
    background-color: var(--bg-3);
    z-index: 1000;
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    padding: 15px 0;
    border-top: 2px solid var(--gold);
  }

  .menu.active {
    display: flex;
  }

  .menu li {
    width: 100%;
    text-align: center;
  }

  nav a {
    margin: 0;
    padding: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 1.1rem;
  }

  nav a:last-child {
    border-bottom: none;
  }

  .nav-container {
    padding: 0;
    justify-content: flex-start;
  }

  .action-buttons {
    flex-direction: column;
  }

  .btn {
    width: 100%;
  }

  .info-section {
    padding: 20px 15px;
  }

  /* Responsividade para o modal */
  .modal-content {
    margin: 5% auto;
    padding: 20px;
    width: 95%;
    max-width: 600px;
  }
  
  .modal-header h2 {
    font-size: 24px;
  }
  
  .avatar-options {
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
  }
  
  .avatar-option {
    width: 85px;
    height: 85px;
  }
  
  .close-modal {
    font-size: 28px;
    width: 35px;
    height: 35px;
  }

  .profile-picture {
    width: 100px;
    height: 100px;
  }
}

@media (max-width: 480px) {
  .modal-content {
    padding: 15px;
    margin: 10% auto;
    width: 98%;
  }
  
  .modal-header {
    margin-bottom: 20px;
  }
  
  .modal-header h2 {
    font-size: 20px;
  }
  
  .avatar-options {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .avatar-option {
    width: 75px;
    height: 75px;
  }
  
  .close-modal {
    font-size: 24px;
    width: 30px;
    height: 30px;
  }

  .profile-info h1 {
    font-size: 20px;
  }

  .profile-info .poker-nickname {
    font-size: 16px;
  }

  .aviso18 { 
    flex-direction: column; 
    text-align: center; 
  }
}

/* Efeito de overlay para o modal */
.avatar-modal::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(45deg, rgba(255, 204, 0, 0.1), rgba(255, 204, 0, 0.05));
  pointer-events: none;
}
</style>
</head>
<body>



 <header>
 <button class="menu-toggle" aria-label="Abrir menu">
 <span></span>
 <span></span>
 <span></span>
 </button>
 </header>



 <nav>
 <div class="nav-container">
 <ul class="menu">
 <li><a href="index.html">Home</a></li>
 <li><a href="pppoker.html">PPPoker</a></li>
 <li><a href="suprema.html">Suprema Poker</a></li>
 <li><a href="torneios.html">Torneios</a></li>
 <li><a href="regrasdopoker.html">Regras do Poker</a></li>
 <li><a href="divulgacao.html">Divulgação</a></li>
 <li><a href="dicionario.html">Dicionário</a></li>
 <li><a href="blog.html">Blog</a></li>
 <li><a href="contato.html">Contato</a></li>
 </ul>
 </div>
 </nav>



 <main>
 <div class="profile-header">
 <div class="profile-picture" id="upload-foto">
 <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMxYzRjMjkiLz48dGV4dCB4PSI2MCIgeT0iNjUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0MCIgZmlsbD0iI2M4YjY1MyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+8J+SujwvdGV4dD48L3N2Zz4=" alt="Foto de perfil">
 <div class="upload-overlay">Alterar Foto</div>
 </div>
 <div class="profile-info">
 <h1 id="user-name">Usuário</h1>
 <div id="user-poker-nickname" class="poker-nickname"></div>
 <p id="user-email">usuario@exemplo.com</p>
 <p>Membro desde: <span id="member-since">01/01/2023</span></p>
 </div>
 </div>



 <div class="profile-content">
 <div class="info-section">
 <h2>Informações Pessoais</h2>
 <form id="profile-form">
 <div class="form-group">
 <label for="nome_completo">Nome Completo</label>
 <input type="text" id="nome_completo" name="nome_completo" disabled>
 </div>

 <div class="form-group">
 <label for="telefone">Telefone</label>
 <input type="tel" id="telefone" name="telefone" disabled>
 </div>

 <div class="form-group">
 <label for="apelido_poker">Apelido no Poker</label>
 <input type="text" id="apelido_poker" name="apelido_poker" disabled>
 </div>

<!-- Modal de seleção de avatares -->
<div id="avatar-modal" class="avatar-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Selecionar Avatar</h2>
      <span class="close-modal">&times;</span>
    </div>
    <div class="modal-body">
      <div class="avatar-options" id="avatar-options-modal">
        <!-- Os avatares serão carregados aqui -->
      </div>
    </div>
  </div>
</div>

 <div class="form-group">
 <label for="plataforma_preferida">Plataforma Preferida</label>
 <select id="plataforma_preferida" name="plataforma_preferida" disabled>
 <option value="">Selecione uma plataforma</option>
 <option value="PPPoker">PPPoker</option>
 <option value="Suprema Poker">Suprema Poker</option>
 <option value="Outras">Outras</option>
 </select>
 </div>

 <div class="action-buttons">
 <button type="button" id="btn-editar" class="btn btn-primary">Editar Perfil</button>
 <button type="button" id="btn-salvar" class="btn btn-primary btn-hidden">Salvar</button>
 <button type="button" id="btn-cancelar" class="btn btn-secondary btn-hidden">Cancelar</button>
 </div>
 </form>
 </div>
 </div>
 </main>



 <div id="notification" class="notification">
 <span class="notification-icon"></span>
 <span id="notification-message"></span>
 </div>



 <footer>
 <p>&copy; 2025 Guilda do Poker - Todos os direitos reservados</p>
 <div>
 <img src="logoguildapoker.png" alt="Logo Guilda do Poker">
 <img src="logopppoker.png" alt="Logo PPPoker">
 <img src="logosupremapoker.png" alt="Logo Suprema Poker">
 <img src="logocaveirapoker.png" alt="Logo Caveira Poker">
 </div>
 <div class="aviso18">
 <span class="icone18">18+</span>
 <p>Proibido para menores de 18 anos. Jogue com responsabilidade.</p>
 </div>
 <div style="margin-top: 15px; text-align: center;">
 <a href="politica.html" style="color: #bbb; text-decoration: underline; margin: 0 10px;">Política de Privacidade</a>
 <span style="color: #666;">|</span>
 <a href="termos.html" style="color: #bbb; text-decoration: underline; margin: 0 10px;">Termos e Condições</a>
 </div>
 </footer>

<script>
// Configuração do Supabase
const supabaseUrl = 'https://ffyectkjlwgqzjgwhexy.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmeWVjdGtqbHdncXpqZ3doZXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTAxNDAsImV4cCI6MjA3MTg4NjE0MH0.bWxnDQaJ6wILzK09TZ9B9ZdUdqVS7bukabBwZDmyvrE';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Elementos DOM
const userNameElement = document.getElementById('user-name');
const userEmailElement = document.getElementById('user-email');
const userPokerNicknameElement = document.getElementById('user-poker-nickname');
const memberSinceElement = document.getElementById('member-since');
const nomeCompletoInput = document.getElementById('nome_completo');
const telefoneInput = document.getElementById('telefone');
const apelidoPokerInput = document.getElementById('apelido_poker');
const plataformaSelect = document.getElementById('plataforma_preferida');
const uploadFoto = document.getElementById('upload-foto');

const btnEditar = document.getElementById('btn-editar');
const btnSalvar = document.getElementById('btn-salvar');
const btnCancelar = document.getElementById('btn-cancelar');

const notification = document.getElementById('notification');
const notificationMessage = document.getElementById('notification-message');

// Estado de edição
let editMode = false;
let originalValues = {};
let currentAvatarId = null;
let avataresCarregados = false;

// Função para mostrar notificações
function showNotification(message, isSuccess = true) {
  notificationMessage.textContent = message;
  notification.className = isSuccess ? 'notification success' : 'notification error';
  notification.classList.add('show');

  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Adicionar evento para fechar o modal
document.querySelector('.close-modal').addEventListener('click', function() {
  document.getElementById('avatar-modal').style.display = 'none';
});

// Fechar o modal ao clicar fora dele
window.addEventListener('click', function(event) {
  const modal = document.getElementById('avatar-modal');
  if (event.target === modal) {
    modal.style.display = 'none';
  }
});

// Menu mobile toggle
const menuToggle = document.querySelector('.menu-toggle');
const menu = document.querySelector('.menu');

menuToggle.addEventListener('click', function(e) {
  e.stopPropagation();
  menu.classList.toggle('active');
  menuToggle.classList.toggle('active');
});

// Fechar menu ao clicar em um link (em dispositivos móveis)
const menuLinks = document.querySelectorAll('.menu a');
menuLinks.forEach(link => {
  link.addEventListener('click', function() {
    if (window.innerWidth <= 768) {
      menu.classList.remove('active');
      menuToggle.classList.remove('active');
    }
  });
});

// Fechar o menu ao clicar fora dele
document.addEventListener('click', function(event) {
  if (window.innerWidth <= 768 && menu.classList.contains('active')) {
    if (!menu.contains(event.target) && !menuToggle.contains(event.target)) {
      menu.classList.remove('active');
      menuToggle.classList.remove('active');
    }
  }
});

// Verificar estado de autenticação
async function checkAuthState() {
  try {
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    
    if (sessionError) {
      console.error('Erro ao obter sessão:', sessionError);
      showNotification('Erro de autenticação. Redirecionando...', false);
      setTimeout(() => window.location.href = 'index.html', 2000);
      return;
    }

    console.log('Sessão:', session ? 'Usuário autenticado' : 'Não autenticado');

    if (!session) {
      showNotification('Por favor, faça login primeiro', false);
      setTimeout(() => window.location.href = 'index.html', 2000);
      return;
    }

    await loadUserData(session.user);
  } catch (error) {
    console.error('Erro na autenticação:', error);
    showNotification('Erro de conexão. Tente novamente.', false);
  }
}

// Criar perfil de usuário se não existir
async function createUserProfile(user) {
  try {
    const { error } = await supabase
      .from('perfis')
      .insert([
        {
          id: user.id,
          nome_completo: user.user_metadata.full_name || '',
          email: user.email,
          data_criacao: new Date().toISOString()
        }
      ]);

    if (error) {
      // Ignorar erro de duplicidade (código 23505)
      if (error.code === '23505') {
        console.log('Perfil já existe, ignorando criação...');
        return true;
      }
      console.error('Erro ao criar perfil:', error);
      return false;
    }
    return true;
  } catch (error) {
    console.error('Erro inesperado ao criar perfil:', error);
    return false;
  }
}

// Carregar dados do usuário
async function loadUserData(user) {
  try {
    console.log('Iniciando carregamento de dados para:', user.id);
    
    // Primeiro tenta buscar dados básicos
    let { data: perfilData, error: perfilError } = await supabase
      .from('perfis')
      .select('*')
      .eq('id', user.id)
      .single();

    // Se não encontrar perfil, cria um novo
    if (perfilError && perfilError.code === 'PGRST116') {
      console.log('Perfil não existe, criando novo...');
      const criado = await createUserProfile(user);
      if (criado) {
        // Recarrega os dados após criar
        const { data: newPerfilData } = await supabase
          .from('perfis')
          .select('*')
          .eq('id', user.id)
          .single();
        perfilData = newPerfilData;
      } else {
        showNotification('Erro ao criar perfil. Tente novamente.', false);
        return;
      }
    }
    
    if (perfilError && perfilError.code !== 'PGRST116') {
      console.error('Erro ao carregar perfil:', perfilError);
      showNotification('Erro ao carregar perfil.', false);
      return;
    }

    // PREENCHER OS DADOS NA PÁGINA
    userNameElement.textContent = perfilData?.nome_completo || user.user_metadata.full_name || 'Usuário';
    userEmailElement.textContent = user.email;

    if (perfilData?.apelido_poker) {
      userPokerNicknameElement.textContent = '"' + perfilData.apelido_poker + '"';
    } else {
      userPokerNicknameElement.textContent = '';
    }

    const createdDate = new Date(user.created_at);
    memberSinceElement.textContent = createdDate.toLocaleDateString('pt-BR');

    nomeCompletoInput.value = perfilData?.nome_completo || '';
    telefoneInput.value = perfilData?.telefone || '';
    apelidoPokerInput.value = perfilData?.apelido_poker || '';
    plataformaSelect.value = perfilData?.plataforma_preferida || '';

    // Carregar avatar se existir
    if (perfilData?.avatar_id) {
      currentAvatarId = perfilData.avatar_id;
      await updateAvatarDisplay(perfilData.avatar_id);
    }

    originalValues = {
      nome_completo: nomeCompletoInput.value,
      telefone: telefoneInput.value,
      apelido_poker: apelidoPokerInput.value,
      plataforma_preferida: plataformaSelect.value,
      avatar_id: currentAvatarId
    };

    console.log('Dados carregados com sucesso!');
    
  } catch (error) {
    console.error('Erro geral no carregamento:', error);
    showNotification('Erro ao carregar dados do perfil.', false);
  }
}

// Atualizar perfil do usuário
async function updateUserProfile() {
  try {
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    if (sessionError || !session) {
      showNotification('Sessão expirada. Faça login novamente.', false);
      setTimeout(() => window.location.href = 'index.html', 2000);
      return false;
    }

    if (!nomeCompletoInput.value.trim()) {
      showNotification('Por favor, informe seu nome completo.', false);
      nomeCompletoInput.focus();
      return false;
    }

    // Verificar se há um avatar selecionado
    let avatarId = currentAvatarId;
    const selectedAvatarModal = document.querySelector('#avatar-options-modal .avatar-option.selected');
    if (selectedAvatarModal && selectedAvatarModal.dataset.id) {
      avatarId = parseInt(selectedAvatarModal.dataset.id);
    }

    const updates = {
      nome_completo: nomeCompletoInput.value.trim(),
      telefone: telefoneInput.value.trim(),
      apelido_poker: apelidoPokerInput.value.trim(),
      plataforma_preferida: plataformaSelect.value,
      data_atualizacao: new Date().toISOString()
    };

    // Adicionar avatar_id apenas se foi selecionado um
    if (avatarId) {
      updates.avatar_id = avatarId;
    } else {
      updates.avatar_id = null;
    }

    const { error } = await supabase
      .from('perfis')
      .update(updates)
      .eq('id', session.user.id);

    if (error) {
      console.error('Erro ao atualizar perfil:', error);
      
      if (error.message.includes('Invalid API key') || error.message.includes('JWT')) {
        showNotification('Erro de configuração. Entre em contato com o suporte.', false);
      } else {
        showNotification('Erro ao salvar alterações. Tente novamente.', false);
      }
      
      return false;
    }

    showNotification('Perfil atualizado com sucesso!', true);
    
    // Atualizar a exibição
    userNameElement.textContent = nomeCompletoInput.value;
    
    if (apelidoPokerInput.value) {
      userPokerNicknameElement.textContent = '"' + apelidoPokerInput.value + '"';
    } else {
      userPokerNicknameElement.textContent = '';
    }
    
    if (avatarId) {
      await updateAvatarDisplay(avatarId);
    } else {
      // Reset para avatar padrão se nenhum avatar foi selecionado
      const defaultAvatar = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiMxYzRjMjkiLz48dGV4dCB4PSI2MCIgeT0iNjUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSI0MCIgZmlsbD0iI2M4YjY1MyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+8J+SujwvdGV4dD48L3N2Zz4=';
      document.querySelector('.profile-picture img').src = defaultAvatar;
    }
    
    originalValues = { ...updates, avatar_id: avatarId };
    currentAvatarId = avatarId;
    
    return true;
  } catch (error) {
    console.error('Erro inesperado ao atualizar perfil:', error);
    showNotification('Erro inesperado. Tente novamente.', false);
    return false;
  }
}

// Event Listeners para os botões do perfil
btnEditar.addEventListener('click', () => {
  entrarModoEdicao();
});

btnCancelar.addEventListener('click', () => {
  sairModoEdicao();
});

btnSalvar.addEventListener('click', async () => {
  const success = await updateUserProfile();
  if (success) {
    sairModoEdicao();
  }
});

// Funções para entrar/sair do modo edição
function entrarModoEdicao() {
  editMode = true;
  nomeCompletoInput.disabled = false;
  telefoneInput.disabled = false;
  apelidoPokerInput.disabled = false;
  plataformaSelect.disabled = false;

  btnEditar.classList.add('btn-hidden');
  btnSalvar.classList.remove('btn-hidden');
  btnCancelar.classList.remove('btn-hidden');
}

function sairModoEdicao() {
  editMode = false;
  nomeCompletoInput.disabled = true;
  telefoneInput.disabled = true;
  apelidoPokerInput.disabled = true;
  plataformaSelect.disabled = true;
  
  // Restaurar valores originais
  nomeCompletoInput.value = originalValues.nome_completo;
  telefoneInput.value = originalValues.telefone;
  apelidoPokerInput.value = originalValues.apelido_poker;
  plataformaSelect.value = originalValues.plataforma_preferida;
  
  // Restaurar avatar selecionado
  document.querySelectorAll('.avatar-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  if (originalValues.avatar_id) {
    const originalAvatar = document.querySelector(`.avatar-option[data-id="${originalValues.avatar_id}"]`);
    if (originalAvatar) {
      originalAvatar.classList.add('selected');
    }
  }
  
  btnEditar.classList.remove('btn-hidden');  
  btnSalvar.classList.add('btn-hidden');  
  btnCancelar.classList.add('btn-hidden');  
}

// Carregar avatares quando o modal é aberto
uploadFoto.addEventListener('click', async () => {
  document.getElementById('avatar-modal').style.display = 'block';
  
  // Se os avatares ainda não foram carregados, carregue-os
  if (!avataresCarregados) {
    await loadAvatares();
  }
});

// Inicialização
document.addEventListener('DOMContentLoaded', function() {
  console.log('Página carregada - iniciando...');
  checkAuthState();
});

// Carregar avatares disponíveis
async function loadAvatares() {
  try {
    console.log('Carregando avatares...');
    const { data, error } = await supabase
      .from('avatares')
      .select('*')
      .eq('ativo', true)
      .order('id');

    if (error) {
      console.error('Erro ao carregar avatares:', error);
      showNotification('Erro ao carregar avatares.', false);
      return;
    }

    console.log('Avatares encontrados:', data.length);
    displayAvatares(data);
    avataresCarregados = true;
  } catch (error) {
    console.error('Erro inesperado ao carregar avatares:', error);
    showNotification('Erro ao carregar avatares.', false);
  }
}

// Exibir avatares na interface
function displayAvatares(avatares) {
  const avatarOptions = document.getElementById('avatar-options-modal');
  avatarOptions.innerHTML = '';

  if (avatares.length === 0) {
    avatarOptions.innerHTML = '<p style="color: #fff; text-align: center;">Nenhum avatar disponível</p>';
    return;
  }

  avatares.forEach(avatar => {
    const avatarElement = document.createElement('div');
    avatarElement.className = 'avatar-option';
    avatarElement.dataset.id = avatar.id;
    avatarElement.innerHTML = `<img src="${avatar.url_imagem}" alt="${avatar.nome}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiMxYzRjMjkiLz48dGV4dCB4PSI0MCIgeT0iNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2M4YjY1MyIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+8J+SujwvdGV4dD48L3N2Zz4='">`;
    
    avatarElement.addEventListener('click', () => {
      selectAvatar(avatar.id);
    });
    
    // Marcar como selecionado se for o avatar atual
    if (avatar.id === currentAvatarId) {
      avatarElement.classList.add('selected');
    }
    
    avatarOptions.appendChild(avatarElement);
  });
}

// Selecionar um avatar
function selectAvatar(avatarId) {
  document.querySelectorAll('.avatar-option').forEach(option => {
    option.classList.remove('selected');
  });
  
  const selectedAvatar = document.querySelector(`.avatar-option[data-id="${avatarId}"]`);
  if (selectedAvatar) {
    selectedAvatar.classList.add('selected');
    currentAvatarId = avatarId;
  }
}

// Atualizar a exibição do avatar
async function updateAvatarDisplay(avatarId) {
  try {
    const { data, error } = await supabase
      .from('avatares')
      .select('url_imagem')
      .eq('id', avatarId)
      .single();

    if (error || !data) {
      console.error('Erro ao buscar avatar:', error);
      return;
    }

    const profileImg = document.querySelector('.profile-picture img');
    profileImg.src = data.url_imagem;
  } catch (error) {
    console.error('Erro ao atualizar exibição do avatar:', error);
  }
}

// Função de logout
async function logout() {
  try {
    const { error } = await supabase.auth.signOut();
    if (error) {
      console.error('Erro ao fazer logout:', error);
    }
    window.location.href = 'index.html';
  } catch (error) {
    console.error('Erro inesperado no logout:', error);
    window.location.href = 'index.html';
  }
}

// Adicionar suporte para tecla Enter no formulário
document.getElementById('profile-form').addEventListener('keypress', function(e) {
  if (e.key === 'Enter' && editMode) {
    e.preventDefault();
    btnSalvar.click();
  }
});

// Verificar conexão com Supabase
async function testSupabaseConnection() {
  try {
    const { data, error } = await supabase
      .from('perfis')
      .select('count')
      .limit(1);
    
    return !error;
  } catch (error) {
    console.error('Erro ao testar conexão:', error);
    return false;
  }
}
</script>
</body>
</html>

