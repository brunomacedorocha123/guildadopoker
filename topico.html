<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tópico - Fórum da Guilda do Poker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #121212;
      --bg-2: #1c1c1c;
      --bg-3: #2c2c2c;
      --gold: #ffcc00;
      --text: #f5f5f5;
      --text-gray: #bbb;
    }

    body { 
      background: var(--bg); 
      color: var(--text); 
      font-family: Arial, sans-serif; 
    }

    a { 
      color: var(--gold); 
      text-decoration: none; 
    }

    a:hover { 
      text-decoration: underline; 
    }

    .container { 
      max-width: 1000px; 
      margin: 40px auto; 
      padding: 0 20px; 
    }

    header, footer { 
      background: var(--bg-2); 
      padding: 20px; 
      text-align: center; 
      border-bottom: 2px solid var(--gold); 
    }

    .topic-title { 
      color: var(--gold); 
      margin-bottom: 5px; 
    }

    .topic-meta { 
      color: #999; 
      margin-bottom: 20px; 
    }

    .topic-body, .comentario-form, .comentario-item { 
      background: var(--bg-2); 
      border-radius: 8px; 
      padding: 15px; 
      margin-bottom: 20px; 
    }

    .comentario-item { 
      border-left: 4px solid var(--gold); 
    }

    .comentario-usuario { 
      color: var(--gold); 
      font-weight: bold; 
    }

    .comentario-textarea { 
      width: 100%; 
      background: var(--bg-3); 
      color: var(--text); 
      border: 1px solid var(--bg-3); 
      border-radius: 5px; 
      padding: 8px; 
      resize: none; 
    }

    .btn-gold { 
      background: var(--gold); 
      color: #000; 
      border: none; 
    }

    .btn-gold:hover { 
      background: #e6b800; 
      color: #000; 
    }

    .avatar-small { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      object-fit: cover; 
      border: 2px solid var(--gold); 
      margin-right: 10px; 
    }

    .user-profile { 
      position: absolute; 
      right: 20px; 
      top: 20px; 
      display: flex; 
      align-items: center; 
    }

    .user-avatar { 
      width: 40px; 
      height: 40px; 
      border-radius: 50%; 
      border: 2px solid var(--gold); 
      margin-right: 10px; 
    }

    .user-name { 
      color: var(--gold); 
      font-weight: bold; 
    }

    .footer-content {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .footer-content img { 
      max-height: 40px; 
      height: auto; 
    }

    .aviso18 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }

    .icone18 {
      background: red;
      color: white;
      font-weight: bold;
      font-size: 14px;
      padding: 4px 8px;
      border-radius: 5px;
    }

    .aviso18 p { 
      margin: 0; 
      color: #ccc; 
    }

    .footer-links {
      margin-top: 15px;
      text-align: center;
    }

    .footer-links a {
      color: #bbb;
      text-decoration: underline;
      margin: 0 10px;
    }

    .login-prompt {
      text-align: center;
      padding: 10px;
      background: var(--bg-3);
      border-radius: 5px;
      margin-top: 10px;
    }

    #user-profile { 
      display: none; 
    }

    .modal-content {
      background-color: var(--bg-2);
      color: var(--text);
    }

    .modal-header {
      border-bottom: 1px solid var(--bg-3);
    }

    .modal-footer {
      border-top: 1px solid var(--bg-3);
    }

    .form-control {
      background-color: var(--bg-3);
      color: var(--text);
      border: 1px solid var(--bg-3);
    }

    .form-control:focus {
      background-color: var(--bg-3);
      color: var(--text);
      border-color: var(--gold);
      box-shadow: 0 0 0 0.25rem rgba(255, 204, 0, 0.25);
    }

    .btn-close {
      filter: invert(1);
    }
  </style>
</head>
<body>

  <header style="position: relative;">
    <div id="user-profile" class="user-profile">
      <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
      <span id="user-name" class="user-name"></span>
      <button id="btn-logout" class="btn btn-sm btn-outline-warning ms-2">Sair</button>
    </div>
    <h1 class="topic-title">Carregando...</h1>
    <div class="topic-meta"></div>
    <a href="forum.html"><i class="fas fa-arrow-left"></i> Voltar aos tópicos</a>
  </header>

  <main class="container">
    <article class="topic-body">
      <p>Carregando conteúdo...</p>
    </article>

    <section class="comentarios-container">
      <h3>Comentários</h3>
      <div id="comentario-form" class="comentario-form" style="display: none;">
        <textarea id="novo-comentario" class="comentario-textarea" placeholder="Digite seu comentário... (máx 1000 caracteres)" maxlength="1000" rows="3"></textarea>
        <button id="btn-comentar" class="btn btn-gold mt-2">Comentar</button>
      </div>
      <div id="login-prompt" class="login-prompt">
        <p>Você precisa <a href="#" id="login-link">fazer login</a> para comentar.</p>
      </div>
      <div id="lista-comentarios">
        <p>Carregando comentários...</p>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Guilda do Poker - Todos os direitos reservados</p>
    <div class="footer-content">
      <img src="logoguidapoker1.png" alt="Logo Guilda do Poker">
      <img src="logopppoker.png" alt="Logo PPPoker">
      <img src="logosupremapoker.png" alt="Logo Suprema Poker">
      <img src="logocaveirapoker.png" alt="Logo Caveira Poker">
    </div>
    <div class="aviso18">
      <span class="icone18">18+</span>
      <p>Proibido para menores de 18 anos. Jogue com responsabilidade.</p>
    </div>
    <div class="footer-links">
      <a href="politica.html">Política de Privacidade</a>
      <span style="color: #666;">|</span>
      <a href="termos.html">Termos e Condições</a>
    </div>
  </footer>

  <!-- Modal de Login -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="loginModalLabel">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="login-error" class="alert alert-danger" style="display: none;"></div>
          <form id="login-form">
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Senha</label>
              <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-gold w-100">Entrar</button>
          </form>
          <p class="mt-3 text-center">
            Não tem uma conta? <a href="#" id="register-link">Registre-se</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Registro -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="registerModalLabel">Criar Conta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="register-error" class="alert alert-danger" style="display: none;"></div>
          <div id="register-success" class="alert alert-success" style="display: none;"></div>
          <form id="register-form">
            <div class="mb-3">
              <label for="register-email" class="form-label">Email</label>
              <input type="email" class="form-control" id="register-email" required>
            </div>
            <div class="mb-3">
              <label for="register-password" class="form-label">Senha</label>
              <input type="password" class="form-control" id="register-password" required>
            </div>
            <div class="mb-3">
              <label for="register-apelido" class="form-label">Apelido</label>
              <input type="text" class="form-control" id="register-apelido" required>
            </div>
            <button type="submit" class="btn btn-gold w-100">Criar Conta</button>
          </form>
          <p class="mt-3 text-center">
            Já tem uma conta? <a href="#" id="login-modal-link">Faça login</a>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Config Supabase
    const supabaseUrl = "https://ffyectkjlwgqzjgwhexy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhbmFzZSIsInJlZiI6ImZmeWVjdGtqbHdncXpqZ3doZXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTAxNDAsImV4cCI6MjA3MTg4NjE0MH0.bWxnDQaJ6wILzK09TZ9B9ZdUdqVS7bukabBwZDmyvrE";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Elementos DOM
    const topicTitleEl = document.querySelector('.topic-title');
    const topicMetaEl = document.querySelector('.topic-meta');
    const topicBodyEl = document.querySelector('.topic-body');
    const listaComentariosEl = document.getElementById('lista-comentarios');
    const comentarioFormEl = document.getElementById('comentario-form');
    const loginPromptEl = document.getElementById('login-prompt');
    const userProfileEl = document.getElementById('user-profile');
    const userAvatarEl = document.getElementById('user-avatar');
    const userNameEl = document.getElementById('user-name');
    const btnLogoutEl = document.getElementById('btn-logout');
    const loginLinkEl = document.getElementById('login-link');
    const loginFormEl = document.getElementById('login-form');
    const registerFormEl = document.getElementById('register-form');
    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
    const registerModal = new bootstrap.Modal(document.getElementById('registerModal'));
    const loginModalLinkEl = document.getElementById('login-modal-link');
    const registerLinkEl = document.getElementById('register-link');

    // Captura ID do tópico da URL
    const urlParams = new URLSearchParams(window.location.search);
    const topicoId = urlParams.get('id');

    // Verificar autenticação do usuário - CORRIGIDO
    async function checkAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (user) {
        userProfileEl.style.display = 'flex';
        comentarioFormEl.style.display = 'block';
        loginPromptEl.style.display = 'none';
        
        // CORRIGIDO: apelido_poker
        const { data: perfil, error } = await supabase
          .from('perfis')
          .select('apelido_poker, avatar_id')
          .eq('id', user.id)
          .single();
          
        if (perfil) {
          userNameEl.textContent = perfil.apelido_poker || user.email;
          
          // CORRIGIDO: url_imagem
          if (perfil.avatar_id) {
            const { data: avatar } = await supabase
              .from('avatares')
              .select('url_imagem')
              .eq('id', perfil.avatar_id)
              .single();
              
            if (avatar) {
              userAvatarEl.src = avatar.url_imagem;
            } else {
              userAvatarEl.src = 'https://via.placeholder.com/40x40/2c2c2c/ffcc00?text=U';
            }
          } else {
            userAvatarEl.src = 'https://via.placeholder.com/40x40/2c2c2c/ffcc00?text=U';
          }
        } else {
          userNameEl.textContent = user.email;
          userAvatarEl.src = 'https://via.placeholder.com/40x40/2c2c2c/ffcc00?text=U';
        }
      } else {
        userProfileEl.style.display = 'none';
        comentarioFormEl.style.display = 'none';
        loginPromptEl.style.display = 'block';
      }
    }

    // Carregar tópico - CORRIGIDO (busca autor)
    async function carregarTopico() {
      try {
        // CORRIGIDO: Agora busca informações do autor também
        const { data, error } = await supabase
          .from('topicos')
          .select(`
            *,
            perfis (
              apelido_poker,
              avatar_id
            )
          `)
          .eq('id', topicoId)
          .single();

        if (error || !data) {
          topicTitleEl.textContent = "Tópico não encontrado";
          topicBodyEl.innerHTML = '<p>Erro ao carregar o tópico.</p>';
          return;
        }

        topicTitleEl.textContent = data.titulo;
        
        // CORRIGIDO: Mostra o autor
        const autor = data.perfis?.apelido_poker || 'Administrador';
        const dataCriacao = new Date(data.criado_em || data.created_at);
        const dataFormatada = dataCriacao.toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        // CORRIGIDO: Agora mostra o autor
        topicMetaEl.innerHTML = `Por: <strong>${autor}</strong> | Em: ${dataFormatada}`;
        topicBodyEl.innerHTML = `<p>${data.descricao || 'Sem descrição'}</p>`;
      } catch (err) {
        console.error("Erro ao carregar tópico:", err);
        topicBodyEl.innerHTML = '<p>Ocorreu um erro ao carregar o tópico.</p>';
      }
    }

    // Carregar comentários - CORRIGIDO
    async function carregarComentarios() {
      try {
        let { data, error } = await supabase
          .from('respostas')
          .select(`
            *,
            perfis (
              apelido_poker,
              avatar_id
            )
          `)
          .eq('topico_id', topicoId)
          .order('criado_em', { ascending: true });

        if (error) {
          console.warn("Erro ao buscar comentários:", error);
          const { data: dataSimple, error: errorSimple } = await supabase
            .from('respostas')
            .select('*')
            .eq('topico_id', topicoId)
            .order('criado_em', { ascending: true });
          
          data = dataSimple;
          error = errorSimple;
        }

        if (error) {
          listaComentariosEl.innerHTML = '<p>Erro ao carregar comentários.</p>';
          return;
        }

        if (!data || data.length === 0) {
          listaComentariosEl.innerHTML = '<p>Nenhum comentário ainda.</p>';
          return;
        }

        listaComentariosEl.innerHTML = '';
        
        for (const comentario of data) {
          const dataComentario = new Date(comentario.criado_em || comentario.created_at);
          const dataFormatada = dataComentario.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          // CORRIGIDO: apelido_poker e url_imagem
          let autor = 'Anônimo';
          let avatarUrl = 'https://via.placeholder.com/40x40/2c2c2c/ffcc00?text=A';
          
          if (comentario.perfis && comentario.perfis.apelido_poker) {
            autor = comentario.perfis.apelido_poker;
            
            if (comentario.perfis.avatar_id) {
              const { data: avatar } = await supabase
                .from('avatares')
                .select('url_imagem')
                .eq('id', comentario.perfis.avatar_id)
                .single();
                
              if (avatar) {
                avatarUrl = avatar.url_imagem;
              }
            }
          }
          
          const conteudo = comentario.comentario || comentario.conteudo || 'Sem conteúdo';
          
          listaComentariosEl.innerHTML += `
            <div class="comentario-item d-flex align-items-start mb-3">
              <img src="${avatarUrl}" class="avatar-small" alt="${autor}">
              <div>
                <div class="comentario-usuario">${autor}</div>
                <div class="mb-2">${conteudo}</div>
                <small class="text-muted">${dataFormatada}</small>
              </div>
            </div>
          `;
        }
      } catch (err) {
        console.error("Erro ao carregar comentários:", err);
        listaComentariosEl.innerHTML = '<p>Ocorreu um erro ao carregar os comentários.</p>';
      }
    }

    // Inserir novo comentário
    async function inserirComentario() {
      const conteudo = document.getElementById('novo-comentario').value.trim();
      if (!conteudo) return alert('Digite seu comentário antes de enviar.');

      try {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          alert('Você precisa estar logado para comentar.');
          return;
        }

        const { data, error } = await supabase
          .from('respostas')
          .insert([{ 
            topico_id: topicoId, 
            perfil_id: user.id, 
            comentario: conteudo
          }]);

        if (error) {
          console.error("Erro ao enviar comentário:", error);
          return alert('Erro ao enviar comentário.');
        }

        document.getElementById('novo-comentario').value = '';
        alert('Comentário enviado com sucesso!');
        carregarComentarios();
      } catch (err) {
        console.error("Erro inesperado ao enviar comentário:", err);
        alert('Ocorreu um erro inesperado ao enviar seu comentário.');
      }
    }

    // Login
    async function login(email, password) {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        document.getElementById('login-error').textContent = error.message;
        document.getElementById('login-error').style.display = 'block';
        return false;
      }

      return true;
    }

    // Registrar novo usuário - CORRIGIDO
    async function register(email, password, apelido) {
      const { data: authData, error: authError } = await supabase.auth.signUp({
        email,
        password
      });

      if (authError) {
        document.getElementById('register-error').textContent = authError.message;
        document.getElementById('register-error').style.display = 'block';
        return false;
      }

      // CORRIGIDO: apelido_poker
      const { error: profileError } = await supabase
        .from('perfis')
        .insert([{ 
          id: authData.user.id, 
          apelido_poker: apelido,
          email: email
        }]);

      if (profileError) {
        console.error('Erro ao criar perfil:', profileError);
      }

      document.getElementById('register-success').textContent = 'Conta criada com sucesso! Você já pode fazer login.';
      document.getElementById('register-success').style.display = 'block';
      document.getElementById('register-error').style.display = 'none';
      
      return true;
    }

    // Logout
    async function logout() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Erro ao fazer logout:', error);
      } else {
        window.location.reload();
      }
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', async () => {
      if (!topicoId) {
        topicTitleEl.textContent = "Erro";
        topicBodyEl.innerHTML = '<p>Nenhum tópico especificado.</p>';
        return;
      }
      
      await checkAuth();
      await carregarTopico(); // AGORA VAI MOSTRAR O AUTOR!
      await carregarComentarios();
      
      // Event listeners
      document.getElementById('btn-comentar').addEventListener('click', inserirComentario);
      btnLogoutEl.addEventListener('click', logout);
      loginLinkEl.addEventListener('click', (e) => {
        e.preventDefault();
        loginModal.show();
      });
      
      loginFormEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        const success = await login(email, password);
        if (success) {
          loginModal.hide();
          window.location.reload();
        }
      });
      
      registerLinkEl.addEventListener('click', (e) => {
        e.preventDefault();
        loginModal.hide();
        registerModal.show();
      });
      
      loginModalLinkEl.addEventListener('click', (e) => {
        e.preventDefault();
        registerModal.hide();
        loginModal.show();
      });
      
      registerFormEl.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const apelido = document.getElementById('register-apelido').value;
        
        const success = await register(email, password, apelido);
        if (success) {
          document.getElementById('register-email').value = '';
          document.getElementById('register-password').value = '';
          document.getElementById('register-apelido').value = '';
        }
      });
      
      document.getElementById('novo-comentario').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.ctrlKey && !e.shiftKey) {
          e.preventDefault();
          inserirComentario();
        }
      });
    });
  </script>
</body>
</html>