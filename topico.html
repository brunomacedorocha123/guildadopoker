<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tópico - Fórum da Guilda do Poker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#121212;
      --bg-2:#1c1c1c;
      --bg-3:#2c2c2c;
      --gold:#ffcc00;
      --text:#f5f5f5;
      --text-gray:#bbb;
    }
    body { background: var(--bg); color: var(--text); font-family: Arial, sans-serif; }
    a { color: var(--gold); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
    header, footer { background: var(--bg-2); padding: 20px; text-align: center; border-bottom: 2px solid var(--gold); }
    .topic-title { color: var(--gold); margin-bottom: 5px; }
    .topic-meta { color: #999; margin-bottom: 20px; }
    .topic-body, .comentario-form, .comentario-item { background: var(--bg-2); border-radius: 8px; padding: 15px; margin-bottom: 20px; }
    .comentario-item { border-left: 4px solid var(--gold); }
    .comentario-usuario { color: var(--gold); font-weight: bold; }
    .comentario-textarea { width: 100%; background: var(--bg-3); color: var(--text); border: 1px solid var(--bg-3); border-radius: 5px; padding: 8px; resize: none; }
    .btn-gold { background: var(--gold); color:#000; border:none; }
    .btn-gold:hover { background:#e6b800; color:#000; }
    .avatar-small { width: 40px; height:40px; border-radius:50%; object-fit:cover; border:2px solid var(--gold); margin-right:10px; }
  </style>
</head>
<body>

  <header>
    <h1 class="topic-title">Carregando...</h1>
    <div class="topic-meta"></div>
    <a href="forum.html"><i class="fas fa-arrow-left"></i> Voltar aos tópicos</a>
  </header>

  <main class="container">
    <article class="topic-body">
      <p>Carregando conteúdo...</p>
    </article>

    <section class="comentarios-container">
      <h3>Comentários</h3>
      <div class="comentario-form">
        <textarea id="novo-comentario" class="comentario-textarea" placeholder="Digite seu comentário... (máx 1000 caracteres)" maxlength="1000" rows="3"></textarea>
        <button id="btn-comentar" class="btn btn-gold mt-2">Comentar</button>
      </div>
      <div id="lista-comentarios">
        <p>Carregando comentários...</p>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 Guilda do Poker - Todos os direitos reservados
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Config Supabase
    const supabaseUrl = "https://ffyectkjlwgqzjgwhexy.supabase.co";
    const supabaseKey = "SUA_CHAVE_PUBLICA_AQUI";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Captura ID do tópico da URL
    const urlParams = new URLSearchParams(window.location.search);
    const topicoId = urlParams.get('id');

    const topicTitleEl = document.querySelector('.topic-title');
    const topicMetaEl = document.querySelector('.topic-meta');
    const topicBodyEl = document.querySelector('.topic-body');
    const listaComentariosEl = document.getElementById('lista-comentarios');

    // Carregar tópico
    async function carregarTopico() {
      const { data, error } = await supabase
        .from('topicos')
        .select('*, perfis(id, apelido, avatar_id), avatares(url)')
        .eq('id', topicoId)
        .single();

      if(error || !data){
        topicBodyEl.innerHTML = '<p>Erro ao carregar o tópico.</p>';
        return;
      }

      topicTitleEl.textContent = data.titulo;
      topicMetaEl.textContent = `Por ${data.perfis.apelido || 'Anônimo'} | ${new Date(data.created_at).toLocaleString('pt-BR')}`;
      topicBodyEl.innerHTML = `<p>${data.descricao || ''}</p>`;
    }

    // Carregar comentários
    async function carregarComentarios() {
      const { data, error } = await supabase
        .from('respostas')
        .select('*, perfis(apelido, avatar_id), avatares(url)')
        .eq('topico_id', topicoId)
        .order('created_at', { ascending: true });

      if(error){
        listaComentariosEl.innerHTML = '<p>Erro ao carregar comentários.</p>';
        return;
      }

      if(!data || data.length === 0){
        listaComentariosEl.innerHTML = '<p>Nenhum comentário ainda.</p>';
        return;
      }

      listaComentariosEl.innerHTML = '';
      data.forEach(c => {
        const avatarUrl = c.perfis.avatar_id ? c.avatares?.url : '';
        listaComentariosEl.innerHTML += `
          <div class="comentario-item d-flex align-items-start mb-2">
            <img src="${avatarUrl || 'default-avatar.png'}" class="avatar-small">
            <div>
              <div class="comentario-usuario">${c.perfis.apelido || 'Anônimo'}</div>
              <div>${c.conteudo}</div>
            </div>
          </div>
        `;
      });
    }

    // Inserir novo comentário
    document.getElementById('btn-comentar').addEventListener('click', async () => {
      const conteudo = document.getElementById('novo-comentario').value;
      if(!conteudo) return alert('Digite seu comentário');

      // Aqui você precisa definir o usuário logado:
      const perfilId = 1; // EXEMPLO: ID do usuário logado

      const { data, error } = await supabase
        .from('respostas')
        .insert([{ topico_id: topicoId, perfil_id: perfilId, conteudo }]);

      if(error){
        return alert('Erro ao enviar comentário.');
      }

      document.getElementById('novo-comentario').value = '';
      carregarComentarios();
    });

    // Inicializa
    carregarTopico();
    carregarComentarios();
  </script>
</body>
</html>
