<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tópico - Guilda do Poker</title>
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Estilos básicos */
    :root {
      --bg-primary: #121212;
      --bg-secondary: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #bbbbbb;
      --accent: #ffcc00;
      --border: #333333;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Arial', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    /* Cabeçalho */
    header {
      background-color: var(--bg-secondary);
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .back-button {
      color: var(--accent);
      text-decoration: none;
      font-weight: bold;
      padding: 8px 15px;
      border: 1px solid var(--accent);
      border-radius: 5px;
      transition: all 0.3s;
    }
    
    .back-button:hover {
      background-color: var(--accent);
      color: var(--bg-primary);
    }
    
    /* Área do usuário */
    .user-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: var(--bg-primary);
      border: 2px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .user-nickname {
      font-weight: bold;
      color: var(--accent);
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Conteúdo principal */
    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 0 20px;
    }
    
    .topic-header {
      background-color: var(--bg-secondary);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }
    
    .topic-title {
      color: var(--accent);
      margin-bottom: 15px;
      font-size: 24px;
    }
    
    .topic-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .topic-author-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .topic-author-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .topic-content {
      line-height: 1.8;
      margin-top: 20px;
    }
    
    /* Seção de comentários */
    .comments-section {
      background-color: var(--bg-secondary);
      padding: 20px;
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .comments-title {
      color: var(--accent);
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .comment {
      background-color: var(--bg-primary);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border: 1px solid var(--border);
    }
    
    .comment-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .comment-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      overflow: hidden;
    }
    
    .comment-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .comment-author {
      font-weight: bold;
      color: var(--accent);
    }
    
    .comment-date {
      color: var(--text-secondary);
      font-size: 12px;
    }
    
    .comment-content {
      line-height: 1.6;
    }
    
    .replies {
      margin-left: 30px;
      margin-top: 15px;
      border-left: 2px solid var(--accent);
      padding-left: 15px;
    }
    
    /* Formulário de comentário */
    .add-comment {
      margin-top: 30px;
    }
    
    .add-comment h3 {
      margin-bottom: 15px;
      color: var(--accent);
    }
    
    .comment-form textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 5px;
      margin-bottom: 10px;
      resize: vertical;
    }
    
    .comment-form button {
      background-color: var(--accent);
      color: var(--bg-primary);
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.3s;
    }
    
    .comment-form button:hover {
      opacity: 0.9;
    }
    
    /* Rodapé */
    footer {
      background-color: var(--bg-secondary);
      padding: 20px;
      text-align: center;
      margin-top: 40px;
      border-top: 1px solid var(--border);
      color: var(--text-secondary);
    }
    
    .aviso18 {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .icone18 {
      background-color: var(--accent);
      color: var(--bg-primary);
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 3px;
    }
    
    /* Estados de loading e erro */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 204, 0, 0.3);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error-message {
      color: #ff6b6b;
      padding: 10px;
      background-color: rgba(255, 107, 107, 0.1);
      border-radius: 5px;
      border-left: 3px solid #ff6b6b;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }
      
      .topic-meta {
        flex-wrap: wrap;
      }
      
      .replies {
        margin-left: 15px;
      }
      
      header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- Cabeçalho SEM menu de navegação -->
  <header>
    <div class="header-left">
      <a href="forum.html" class="back-button">
        ← Voltar ao Fórum
      </a>
      <div class="user-area" id="user-area" style="display: none;">
        <div class="user-avatar" id="user-avatar">
          <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSIjZmZjYzAwIj48cGF0aCBkPSJNMTMwLDUwQzEzMCw2Mi44IDEyMCw3Mi41IDEwMCw3Yi41SDcwQzUwLDcyLjUgNDAsNjIuOCA0MCw1MEM0MCwzNy4yIDUwLDI3LjUgNzAsMjcuNUgxMDBDMTIwLDI3LjUgMTMwLDM3LjIgMTMwLDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAsNTAuNUw0MCwxNTBDNDAsMTYyLjggNTAsMTcyLjUgNzAsMTcyLjVIMTMwQzE1MCwxNzIuNSAxNjAsMTYyLjggMTYwLTE1MEwxNjAsNTAuNSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg�IjIiLz48L3N2Zz4=" alt="Avatar" id="avatar-img">
        </div>
        <div class="user-nickname" id="user-nickname">
          <span class="loading" id="loading-indicator"></span>
          <span id="nickname-text"></span>
        </div>
      </div>
    </div>
  </header>

  <!-- Conteúdo Principal -->
  <main class="container">
    <div id="topic-container">
      <div class="topic-header">
        <h1 class="topic-title" id="topic-title">Carregando tópico...</h1>
        <div class="topic-meta" id="topic-meta">
          <div class="loading"></div>
        </div>
        <div class="topic-content" id="topic-content"></div>
      </div>
    </div>

    <div class="comments-section">
      <h2 class="comments-title">Comentários</h2>
      <div id="comments-container">
        <div class="loading"></div>
      </div>

      <div class="add-comment" id="add-comment">
        <h3>Deixe seu comentário</h3>
        <div class="comment-form">
          <textarea id="new-comment" placeholder="Escreva seu comentário..."></textarea>
          <button id="submit-comment">Comentar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Rodapé -->
  <footer>
    <p>© 2025 Guilda do Poker - Todos os direitos reservados</p>
    <div class="aviso18">
      <span class="icone18">18+</span>
      <p>Proibido para menores de 18 anos. Jogue com responsabilidade.</p>
    </div>
    <div style="margin-top: 15px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
      <a href="politica.html" style="color: #bbb; text-decoration: underline;">Política de Privacidade</a>
      <a href="termos.html" style="color: #bbb; text-decoration: underline;">Termos e Condições</a>
    </div>
  </footer>

  <script>
    // Configuração do Supabase
    const SUPABASE_URL = 'https://ffyectkjlwgqzjgwhexy.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmeWVjdGtqbHdncXpqZ3doZXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTAxNDAsImV4cCI6MjA3MTg4NjE0MH0.bWxnDQaJ6wILzK09TZ9B9ZdUdqVS7bukabBwZDmyvrE';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: { persistSession: true, autoRefreshToken: true }
    });

    // Elementos DOM
    const userArea = document.getElementById('user-area');
    const userAvatarImg = document.getElementById('avatar-img');
    const userNicknameEl = document.getElementById('nickname-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const topicTitle = document.getElementById('topic-title');
    const topicMeta = document.getElementById('topic-meta');
    const topicContent = document.getElementById('topic-content');
    const commentsContainer = document.getElementById('comments-container');
    const addCommentSection = document.getElementById('add-comment');
    const newCommentTextarea = document.getElementById('new-comment');
    const submitCommentButton = document.getElementById('submit-comment');

    let topicId = new URLSearchParams(window.location.search).get('id');
    let currentUser = null;

    // Função para obter o usuário atual da sessão
    async function getCurrentUser() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('Erro ao obter sessão:', error);
          return null;
        }
        
        if (!session) {
          console.error('Nenhuma sessão encontrada');
          return null;
        }
        
        return session.user;
      } catch (error) {
        console.error('Erro ao obter usuário atual:', error);
        return null;
      }
    }

    // Função para carregar avatar pelo ID
    async function loadUserAvatar(avatarId) {
        if (!avatarId) return null;
        try {
            const { data: avatarData, error } = await supabase
                .from('avatares')
                .select('url_imagem')
                .eq('id', avatarId)
                .single();
                
            if (error || !avatarData) return null;
            return avatarData.url_imagem;
        } catch (error) {
            console.error('Erro ao carregar avatar:', error);
            return null;
        }
    }

    // Função para carregar perfil do usuário
    async function loadUserProfile(userId) {
        try {
            const { data: perfilData, error } = await supabase
                .from('perfis')
                .select('apelido_poker, avatar_id')
                .eq('usuario_id', userId)
                .single();
                
            if (error) {
                console.error('Erro ao carregar perfil:', error);
                return null;
            }
            return perfilData;
        } catch (error) {
            console.error('Erro ao carregar perfil:', error);
            return null;
        }
    }

    // Atualiza a janela do usuário
    async function updateUserUI(user, profile) {
        if (!userArea) return;
        userArea.style.display = 'flex';

        // esconder loading
        if (loadingIndicator) loadingIndicator.style.display = 'none';

        // definir apelido
        let apelido = profile && profile.apelido_poker ? profile.apelido_poker : user.email.split('@')[0];
        if (userNicknameEl) {
            userNicknameEl.textContent = apelido;
            userNicknameEl.style.display = 'inline';
        }

        // carregar avatar
        if (profile && profile.avatar_id) {
            const avatarUrl = await loadUserAvatar(profile.avatar_id);
            if (avatarUrl && userAvatarImg) {
                userAvatarImg.onerror = function () {
                    console.error('Erro ao carregar avatar, usando padrão');
                    this.src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSIjZmZjYzAwIj48cGF0aCBkPSJNMTMwLDUwQzEzMCw2Mi44IDEyMCw3Mi41IDEwMCw3Yi41SDcwQzUwLDcyLjUgNDAsNjIuOCA0MCw1MEM0MCwzNy4yIDUwLDI3LjUgNzAsMjcuNUgxMDBDMTIwLDI3LjUgMTMwLDM3LjIgMTMwLDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAsNTAuNUw0MCwxNTBDNDAsMTYyLjggNTAsMTcyLjUgNzAsMTcyLjVIMTMwQzE1MCwxNzIuNSAxNjAsMTYyLjggMTYwLTE1MEwxNjAsNTAuNSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=";
                };
                userAvatarImg.src = avatarUrl;
            }
        }
    }

    // Carregar tópico
    async function loadTopic() {
        if (!topicId) {
            topicTitle.textContent = 'Tópico não encontrado';
            topicMeta.innerHTML = '';
            topicContent.textContent = 'O tópico solicitado não existe ou foi removido.';
            return;
        }

        try {
            const { data: topic, error } = await supabase
                .from('topicos')
                .select(`
                    id,
                    titulo,
                    conteudo,
                    criado_em,
                    autor_id,
                    perfis (apelido_poker, avatar_id)
                `)
                .eq('id', topicId)
                .single();
                
            if (error) {
                console.error('Erro ao carregar tópico:', error);
                topicTitle.textContent = 'Erro ao carregar tópico';
                topicContent.textContent = 'Ocorreu um erro ao carregar este tópico.';
                return;
            }
            
            if (!topic) {
                topicTitle.textContent = 'Tópico não encontrado';
                topicContent.textContent = 'O tópico solicitado não existe ou foi removido.';
                return;
            }
            
            // Preencher informações do tópico
            topicTitle.textContent = topic.titulo;
            topicContent.textContent = topic.conteudo || 'Sem conteúdo...';
            
            // Carregar avatar do autor
            let authorAvatarUrl = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSIjZmZjYzAwIj48cGF0aCBkPSJNMTMwLDUwQzEzMCw2Mi44IDEyMCw3Mi41IDEwMCw3Yi41SDcwQzUwLDcyLjUgNDAsNjIuOCA0MCw1MEM0MCwzNy4yIDUwLDI3LjUgNzAsMjcuNUgxMDBDMTIwLDI3LjUgMTMwLDM3LjIgMTMwLDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAsNTAuNUw0MCwxNTBDNDAsMTYyLjggNTAsMTcyLjUgNzAsMTcyLjVIMTMwQzE1MCwxNzIuNSAxNjAsMTYyLjggMTYwLTE1MEwxNjAsNTAuNSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=";
            
            if (topic.perfis && topic.perfis.avatar_id) {
                const avatarUrl = await loadUserAvatar(topic.perfis.avatar_id);
                if (avatarUrl) {
                    authorAvatarUrl = avatarUrl;
                }
            }
            
            const authorName = topic.perfis?.apelido_poker || 'Usuário';
            const topicDate = new Date(topic.criado_em).toLocaleDateString('pt-BR');
            
            topicMeta.innerHTML = `
                <div class="topic-author-avatar">
                    <img src="${authorAvatarUrl}" alt="${authorName}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSIjZmZjYzAwIj48cGF0aCBkPSJNMTMwLDUwQzEzMCw2Mi44IDEyMCw3Mi41IDEwMCw3Yi41HDcwQzUwLDcyLjUgNDAsNjIuOCA0MCw1MEM0MCwzNy4yIDUwLDI3LjUgNzAsMjcuNUgxMDBDMTIwLDI3LjUgMTMwLDM3LjIgMTMwLDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAsNTAuNUw0MCwxNTBDNDAsMTYyLjggNTAsMTcyLjUgNzAsMTcyLjVIMTMwQzE1MCwxNzIuNSwxNjAsMTYyLjgsMTYwLTE1MEwxNjAsNTAuNSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4='">
                </div>
                <div class="topic-author-name">${escapeHtml(authorName)}</div>
                <div>•</div>
                <div>${topicDate}</div>
            `;
            
        } catch (error) {
            console.error('Erro ao carregar tópico:', error);
            topicTitle.textContent = 'Erro ao carregar tópico';
            topicContent.textContent = 'Ocorreu um erro ao carregar este tópico.';
        }
    }

    // Carregar comentários
    async function loadComments() {
        if (!topicId) return;
        
        try {
            const { data: comments, error } = await supabase
                .from('comentarios')
                .select(`
                    id,
                    conteudo,
                    criado_em,
                    usuario_id,
                    parent_id,
                    perfis (apelido_poker, avatar_id)
                `)
                .eq('topico_id', topicId)
                .order('criado_em', { ascending: true });
                
            if (error) {
                console.error('Erro ao carregar comentários:', error);
                commentsContainer.innerHTML = '<div class="error-message">Erro ao carregar comentários</div>';
                return;
            }
            
            if (!comments || comments.length === 0) {
                commentsContainer.innerHTML = '<p>Ainda não há comentários neste tópico. Seja o primeiro a comentar!</p>';
                return;
            }
            
            // Organizar comentários (comentários principais e respostas)
            const mainComments = comments.filter(comment => !comment.parent_id);
            const replies = comments.filter(comment => comment.parent_id);
            
            let commentsHTML = '';
            
            for (const comment of mainComments) {
                commentsHTML += await renderComment(comment, replies);
            }
            
            commentsContainer.innerHTML = commentsHTML;
            
        } catch (error) {
            console.error('Erro ao carregar comentários:', error);
            commentsContainer.innerHTML = '<div class="error-message">Erro ao carregar comentários</div>';
        }
    }

    // Renderizar comentário e suas respostas
    async function renderComment(comment, allReplies, depth = 0) {
        // Carregar avatar do autor do comentário
        let authorAvatarUrl = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSIjZmZjYzAwIj48cGF0aCBkPSJNMTMwLDUwQzEzMCw2Mi44IDEyMCw3Mi41IDEwMCw3Yi41SDcwQzUwLDcyLjUgNDAsNjIuOCA0MCw1MEM0MCwzNy4yIDUwLDI3LjUgNzAsMjcuNUgxMDBDMTIwLDI3LjUgMTMwLDM3LjIgMTMwLDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAsNTAuNUw0MCwxNTBDNDAsMTYyLjggNTAsMTcyLjUgNzAsMTcyLjVIMTMwQzE1MCwxNzIuNSwxNjAsMTYyLjgsMTYwLTE1MEwxNjAsNTAuNSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=";
        
        if (comment.perfis && comment.perfis.avatar_id) {
            const avatarUrl = await loadUserAvatar(comment.perfis.avatar_id);
            if (avatarUrl) {
                authorAvatarUrl = avatarUrl;
            }
        }
        
        const authorName = comment.perfis?.apelido_poker || 'Usuário';
        const commentDate = new Date(comment.criado_em).toLocaleDateString('pt-BR');
        
        let commentHTML = `
            <div class="comment" id="comment-${comment.id}">
                <div class="comment-header">
                    <div class="comment-avatar">
                        <img src="${authorAvatarUrl}" alt="${authorName}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSIjZmZjYzAwIj48cGF0aCBkPSJNMTMwLDUwQzEzMCw2Mi44IDEyMCw3Mi41IDEwMCw3Yi41HDcwQzUwLDcyLjUgNDAsNjIuOCA0MCw1MEM0MCwzNy4yIDUwLDI3LjUgNzAsMjcuNUgxMDBDMTIwLDI3LjUgMTMwLDM3LjIgMTMwLDUwWiIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNDAsNTAuNUw0MCwxNTBDNDAsMTYyLjggNTAsMTcyLjUgNzAsMTcyLjVIMTM0QzE1MCwxNzIuNSwxNjAsMTYyLjgsMTYwLTE1MEwxNjAsNTAuNSIgc3Ryb2tlPSIjMDAwIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4='">
                    </div>
                    <div class="comment-author">${escapeHtml(authorName)}</div>
                    <div class="comment-date">${commentDate}</div>
                </div>
                <div class="comment-content">${escapeHtml(comment.conteudo)}</div>
        `;
        
        // Botão de resposta (só mostra se usuário estiver logado)
        if (currentUser) {
            commentHTML += `
                <button onclick="showReplyForm(${comment.id})" style="margin-top: 10px; background: var(--accent); color: #121212; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Responder</button>
                <div id="reply-form-${comment.id}" class="reply-form" style="display: none; margin-top: 10px;">
                    <textarea id="reply-text-${comment.id}" placeholder="Escreva sua resposta..." style="width: 100%; padding: 8px; margin-bottom: 8px; background: var(--bg-primary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 5px;"></textarea>
                    <button onclick="postReply(${comment.id})" style="background: var(--accent); color: #121212; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Enviar Resposta</button>
                    <button onclick="hideReplyForm(${comment.id})" style="background: #666; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 5px;">Cancelar</button>
                </div>
            `;
        }
        
        // Adicionar respostas a este comentário
        const commentReplies = allReplies.filter(reply => reply.parent_id === comment.id);
        if (commentReplies.length > 0) {
            commentHTML += '<div class="replies">';
            for (const reply of commentReplies) {
                commentHTML += await renderComment(reply, allReplies, depth + 1);
            }
            commentHTML += '</div>';
        }
        
        commentHTML += '</div>';
        return commentHTML;
    }

    // Mostrar formulário de resposta
    function showReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.style.display = 'block';
        }
    }

    // Ocultar formulário de resposta
    function hideReplyForm(commentId) {
        const replyForm = document.getElementById(`reply-form-${commentId}`);
        if (replyForm) {
            replyForm.style.display = 'none';
            document.getElementById(`reply-text-${commentId}`).value = '';
        }
    }

    // Postar comentário principal
    async function postComment() {
        if (!currentUser) {
            alert('Você precisa estar logado para comentar.');
            return;
        }
        
        const content = newCommentTextarea.value.trim();
        if (!content) {
            alert('Digite seu comentário');
            return;
        }
        
        submitCommentButton.disabled = true;
        submitCommentButton.textContent = 'Publicando...';
        
        try {
            const { error } = await supabase
                .from('comentarios')
                .insert([{
                    conteudo: content,
                    topico_id: topicId,
                    usuario_id: currentUser.id
                }]);
                
            if (error) {
                console.error('Erro ao publicar comentário:', error);
                alert('Erro ao publicar comentário. Tente novamente.');
                return;
            }
            
            // Limpar campo e recarregar comentários
            newCommentTextarea.value = '';
            await loadComments();
            
        } catch (error) {
            console.error('Erro ao publicar comentário:', error);
            alert('Erro ao publicar comentário. Tente novamente.');
        } finally {
            submitCommentButton.disabled = false;
            submitCommentButton.textContent = 'Comentar';
        }
    }

    // Postar resposta
    async function postReply(commentId) {
        if (!currentUser) {
            alert('Você precisa estar logado para responder.');
            return;
        }
        
        const replyText = document.getElementById(`reply-text-${commentId}`).value.trim();
        if (!replyText) {
            alert('Digite sua resposta');
            return;
        }
        
        const replyButton = document.querySelector(`#reply-form-${commentId} button`);
        const originalText = replyButton.textContent;
        replyButton.disabled = true;
        replyButton.textContent = 'Publicando...';
        
        try {
            const { error } = await supabase
                .from('comentarios')
                .insert([{
                    conteudo: replyText,
                    topico_id: topicId,
                    usuario_id: currentUser.id,
                    parent_id: commentId
                }]);
                
            if (error) {
                console.error('Erro ao publicar resposta:', error);
                alert('Erro ao publicar resposta. Tente novamente.');
                return;
            }
            
            // Ocultar formulário e recarregar comentários
            hideReplyForm(commentId);
            await loadComments();
            
        } catch (error) {
            console.error('Erro ao publicar resposta:', error);
            alert('Erro ao publicar resposta. Tente novamente.');
        } finally {
            replyButton.disabled = false;
            replyButton.textContent = originalText;
        }
    }

    // Função auxiliar para evitar XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Verificar sessão e carregar dados ao iniciar
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            // Obter usuário atual da sessão
            const user = await getCurrentUser();
            let profile = null;
            
            if (user) {
                profile = await loadUserProfile(user.id);
                currentUser = user;
            }
            
            await updateUserUI(user, profile);
            
            // Carregar tópico e comentários
            await loadTopic();
            await loadComments();
            
            // Se não há usuário logado, esconder formulário de comentário
            if (!user) {
                addCommentSection.style.display = 'none';
            }
            
        } catch (error) {
            console.error('Erro ao inicializar página:', error);
        }
        
        // Adicionar event listener para o botão de comentário
        if (submitCommentButton) {
            submitCommentButton.addEventListener('click', postComment);
        }
    });
  </script>
</body>
</html>